{% extends "base.html" %}
{% block title %}Add New Product{% endblock %}
{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
  /* =========================================================
     1. Design System (Modern EZ)
     ========================================================= */
  :root {
    --np-primary: #4f46e5;
    --np-success: #059669;
    --np-danger: #dc2626;
    --np-warning: #d97706;
    --np-text: #1e293b;
    --np-muted: #64748b;
    --np-border: #e2e8f0;
  }

  .newprod-page {
    padding: 24px;
    max-width: 1200px;
    margin: 0 auto;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    color: var(--np-text);
  }

  /* --- Header --- */
  .newprod-header {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: #fff; padding: 32px 36px; border-radius: 20px; margin-bottom: 32px;
    display: flex; align-items: center; justify-content: space-between; gap: 20px; flex-wrap: wrap;
    box-shadow: 0 10px 30px rgba(79, 70, 229, 0.25);
  }
  .newprod-title { margin: 0; font-size: 30px; font-weight: 800; letter-spacing: -0.5px; }
  .newprod-sub { margin-top: 6px; font-size: 15px; opacity: 0.9; font-weight: 500; }

  /* --- Interactive Buttons --- */
  .np-btn {
    border: none; border-radius: 10px; padding: 12px 22px; font-weight: 700; cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); text-decoration: none;
    display: inline-flex; align-items: center; gap: 10px; font-size: 15px;
  }
  .np-btn.soft { background: rgba(255, 255, 255, 0.12); color: #fff; border: none; padding: 6px 14px; border-radius: 20px; font-size: 12px; }
  .np-btn.soft:hover { background: rgba(255, 255, 255, 0.22); }

  .np-btn.primary { background: var(--np-success); color: #fff; }
  .np-btn.primary:hover { filter: brightness(1.05); }

  /* --- Grid & Card Architecture --- */
  .layout-grid { display: grid; grid-template-columns: 1fr 340px; gap: 24px; align-items: start; }
  @media (max-width: 1100px) { .layout-grid { grid-template-columns: 1fr; } }

  .np-card {
    background: #fff; border-radius: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    border: 1px solid var(--np-border); overflow: hidden; margin-bottom: 24px;
  }
  .np-card-head {
    padding: 14px 20px; background: #fcfcfd; border-bottom: 1px solid var(--np-border);
  }
  .np-card-head h3 { margin: 0; font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--np-muted); letter-spacing: 1px; }
  .np-card-body { padding: 20px; }

  /* --- Field Grid & Logic --- */
  .field-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
  .field-full { grid-column: 1 / -1; }
  @media (max-width: 600px) { .field-group { grid-template-columns: 1fr; } }

  .np-field { display: flex; flex-direction: column; gap: 8px; margin-bottom: 4px; }
  .np-field label { font-size: 12px; font-weight: 800; color: #475569; text-transform: uppercase; letter-spacing: 0.5px; }
  
  .newprod-page input:not([type="checkbox"]),
  .newprod-page select,
  .newprod-page textarea {
    width: 100%; padding: 13px 16px; border: 1.5px solid #cbd5e1; border-radius: 10px;
    font-size: 15px; transition: all 0.2s; background: #fff; color: var(--np-text); font-weight: 500;
  }
  .newprod-page input:focus,
  .newprod-page select:focus,
  .newprod-page textarea:focus {
    outline: none; border-color: var(--np-primary); background: #fff;
    box-shadow: 0 0 0 3px rgba(79,70,229,0.12);
  }

  /* üìÖ Flatpickr Integration */
  .flatpickr-date {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236366f1' viewBox='0 0 16 16'%3E%3Cpath d='M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 18px center; padding-right: 50px !important;
  }

  /* ‚úÖ Toggle & Checkbox Styling */
  .np-toggle-card {
    display: flex; align-items: flex-start; gap: 14px; padding: 18px;
    background: #f8fafc; border: 1px solid var(--np-border); border-radius: 8px;
    transition: all 0.2s; cursor: pointer; margin-bottom: 16px;
  }
  .np-toggle-card:hover { border-color: var(--np-primary); background: #fff; }
  .np-toggle-card input[type="checkbox"] { 
    width: 22px; height: 22px; cursor: pointer; accent-color: var(--np-primary); margin-top: 2px;
  }
  .toggle-text strong { display: block; font-size: 14px; color: var(--np-text); margin-bottom: 2px; }
  .toggle-text span { font-size: 12px; color: var(--np-muted); line-height: 1.4; }

  .np-footer { display: flex; justify-content: flex-end; padding: 40px 0; border-top: 1px solid var(--np-border); }
  .np-field-errors { font-size: 12px; color: var(--np-danger); font-weight: 700; margin-top: 6px; display: flex; align-items: center; gap: 4px; }
/* ‚úÖ Added: Highlight input border when there is an error */
.np-field.has-error input,
  .np-field.has-error select,
  .np-field.has-error textarea {
    border-color: var(--np-danger);
    background-color: #fff5f5;
  }
  
  .non-field-errors {
    background-color: #fef2f2;
    border: 1px solid #fee2e2;
    color: #991b1b;
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 24px;
    font-weight: 600;
    font-size: 14px;
  }
</style>

<div class="newprod-page">
  <div class="newprod-header">
    <div class="header-content">
      <h1 class="newprod-title">Ôºã Add New Product</h1>
      <div class="newprod-sub">Register a new pharmaceutical or retail item.</div>
    </div>
    <div class="newprod-actions">
      <button type="button" class="np-btn soft" id="autofillButton">‚ú® Auto-Fill Sample</button>
      <a class="np-btn soft" href="{{ next|default:'/checkin/' }}">‚Üê Back</a>
    </div>
  </div>

  <form method="post" id="productForm" novalidate>
    {% csrf_token %}
    <input type="hidden" name="next" value="{{ next }}">

    {% if form.non_field_errors %}
      <div class="non-field-errors">
        {% for error in form.non_field_errors %}
          <div>‚ö†Ô∏è {{ error }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="layout-grid">
      
      <div class="main-content">
        
        <div class="np-card">
          <div class="np-card-head"><h3>1. Identification & Category</h3></div>
          <div class="np-card-body">
            <div class="field-group">
              
              <div class="np-field field-full {% if form.name.errors %}has-error{% endif %}">
                <label for="{{ form.name.id_for_label }}">Full Product Name</label>
                {{ form.name }}
                {% if form.name.errors %}<div class="np-field-errors">‚ö†Ô∏è {{ form.name.errors.0 }}</div>{% endif %}
              </div>

              <div class="np-field {% if form.category.errors %}has-error{% endif %}">
                <label for="{{ form.category.id_for_label }}">Classification Category</label>
                {{ form.category }}
                {% if form.category.errors %}<div class="np-field-errors">‚ö†Ô∏è {{ form.category.errors.0 }}</div>{% endif %}
              </div>

              <div class="np-field {% if form.barcode.errors %}has-error{% endif %}">
                <label for="{{ form.barcode.id_for_label }}">GTIN / Barcode</label>
                {{ form.barcode }}
                {% if form.barcode.errors %}<div class="np-field-errors">‚ö†Ô∏è {{ form.barcode.errors.0 }}</div>{% endif %}
              </div>

              <div class="np-field {% if form.item_number.errors %}has-error{% endif %}">
                <label for="{{ form.item_number.id_for_label }}">Internal SKU / Item #</label>
                {{ form.item_number }}
                {% if form.item_number.errors %}<div class="np-field-errors">‚ö†Ô∏è {{ form.item_number.errors.0 }}</div>{% endif %}
              </div>

              <div class="np-field {% if form.unit_size.errors %}has-error{% endif %}">
                <label for="{{ form.unit_size.id_for_label }}">Package Unit Size</label>
                {{ form.unit_size }}
                {% if form.unit_size.errors %}<div class="np-field-errors">‚ö†Ô∏è {{ form.unit_size.errors.0 }}</div>{% endif %}
              </div>

            </div>
          </div>
        </div>

        <div class="np-card">
          <div class="np-card-head"><h3>2. Financials & Inventory</h3></div>
          <div class="np-card-body">
            <div class="field-group">
              
              <div class="np-field {% if form.price_per_unit.errors %}has-error{% endif %}">
                <label for="{{ form.price_per_unit.id_for_label }}">Wholesale Cost ($)</label>
                {{ form.price_per_unit }}
                {% if form.price_per_unit.errors %}<div class="np-field-errors">‚ö†Ô∏è {{ form.price_per_unit.errors.0 }}</div>{% endif %}
              </div>

              <div class="np-field {% if form.price.errors %}has-error{% endif %}">
                <label for="{{ form.price.id_for_label }}">Retail Selling Price ($)</label>
                {{ form.price }}
                {% if form.price.errors %}<div class="np-field-errors">‚ö†Ô∏è {{ form.price.errors.0 }}</div>{% endif %}
              </div>

              <div class="np-field {% if form.quantity_in_stock.errors %}has-error{% endif %}">
                <label for="{{ form.quantity_in_stock.id_for_label }}">Opening Stock Level</label>
                {{ form.quantity_in_stock }}
                {% if form.quantity_in_stock.errors %}<div class="np-field-errors">‚ö†Ô∏è {{ form.quantity_in_stock.errors.0 }}</div>{% endif %}
              </div>

              <div class="np-field {% if form.expiry_date.errors %}has-error{% endif %}">
                <label for="{{ form.expiry_date.id_for_label }}">Product Expiration</label>
                {{ form.expiry_date }}
                {% if form.expiry_date.errors %}<div class="np-field-errors">‚ö†Ô∏è {{ form.expiry_date.errors.0 }}</div>{% endif %}
              </div>

              <div class="np-field field-full {% if form.description.errors %}has-error{% endif %}">
                <label for="{{ form.description.id_for_label }}">Internal Product Notes</label>
                {{ form.description }}
                {% if form.description.errors %}<div class="np-field-errors">‚ö†Ô∏è {{ form.description.errors.0 }}</div>{% endif %}
              </div>

            </div>
          </div>
        </div>

      </div>

      <aside class="side-content">
        <div class="np-card">
          <div class="np-card-head"><h3>Product Settings</h3></div>
          <div class="np-card-body" style="padding: 24px;">
            
            <label class="np-toggle-card">
              {{ form.taxable }}
              <div class="toggle-text">
                <strong>Taxable Item</strong>
                <span>Apply standard sales tax to this product at checkout.</span>
              </div>
            </label>

            <label class="np-toggle-card">
              {{ form.status }}
              <div class="toggle-text">
                <strong>Active Status</strong>
                <span>Product will be visible and available for immediate sale.</span>
              </div>
            </label>

          </div>
        </div>

        <button type="submit" class="np-btn primary" style="width: 100%; justify-content: center; padding: 18px;">
          üíæ Create Product
        </button>
      </aside>

    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. Flatpickr Initialization
    const dateInput = document.getElementById('id_expiry_date');
    if (dateInput) {
        flatpickr(dateInput, {
            dateFormat: "d-m-Y",
            allowInput: true,
            monthSelectorType: "static"
        });

        // 2. Responsive Auto-Dash Logic
        dateInput.addEventListener('input', function(e) {
            let value = this.value.replace(/\D/g, ''); 
            let formatted = '';
            if (value.length > 0) {
                formatted += value.substring(0, 2);
                if (value.length > 2) formatted += '-' + value.substring(2, 4);
                if (value.length > 4) formatted += '-' + value.substring(4, 8);
            }
            if (formatted.length > 10) formatted = formatted.substring(0, 10);
            if (this.value !== formatted) this.value = formatted;
        });
    }

    // 3. Auto-Fill Sample Data
    document.getElementById('autofillButton').addEventListener('click', function () {
        const setVal = (id, value) => {
            const el = document.getElementById(id);
            if (el) {
                el.value = value;
                el.dispatchEvent(new Event('input', { bubbles: true }));
            }
        };

        setVal('id_name', 'Premium Multi-Vitamin Complex');
        setVal('id_item_number', 'SKU-' + Math.floor(10000 + Math.random() * 90000));
        setVal('id_barcode', '8' + Math.floor(Math.random() * 100000000000));
        setVal('id_unit_size', '120 Capsules');
        setVal('id_price_per_unit', '14.25');
        setVal('id_price', '29.99');
        setVal('id_quantity_in_stock', '50');

        const d = new Date();
        d.setMonth(d.getMonth() + 18);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        setVal('id_expiry_date', `${day}-${month}-${year}`);

        if (document.getElementById('id_taxable')) document.getElementById('id_taxable').checked = true;
        if (document.getElementById('id_status')) document.getElementById('id_status').checked = true;
    });
});
</script>
{% endblock %}