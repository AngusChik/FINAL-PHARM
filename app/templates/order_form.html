{% extends 'base.html' %}
{% load static %}
{% block content %}

<style>
    /* â”€â”€ Design System Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
        --of-primary: #4f46e5;
        --of-success: #059669;
        --of-danger: #dc2626;
        --of-warning: #d97706;
        --of-text: #1e293b;
        --of-muted: #64748b;
        --of-border: #e2e8f0;
    }

    /* â”€â”€ Modal wrapper containers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #expiry-confirm-modal,
    #inactive-confirm-modal {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 999998;
    }

    .expiry-modal-backdrop,
    .expiry-modal {
        pointer-events: auto;
    }

    .expiry-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 999999;
    }

    .expiry-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%,-50%);
        background: white;
        padding: 28px;
        border-radius: 12px;
        width: 460px;
        max-width: 90%;
        z-index: 1000000;
        box-shadow: 0 8px 30px rgba(0,0,0,0.18);
        text-align: center;
    }

    .expiry-modal h2 {
        margin-top: 0;
        font-size: 18px;
        font-weight: 700;
        color: var(--of-text);
    }

    .expiry-modal p {
        font-size: 14px;
        line-height: 1.6;
        color: var(--of-text);
    }

    .expiry-modal-actions {
        margin-top: 20px;
        display: flex;
        justify-content: space-between;
        gap: 12px;
    }

    .btn-cancel {
        background: #e2e8f0;
        border: none;
        padding: 10px 18px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 13px;
        cursor: pointer;
        color: var(--of-text);
        transition: background 0.2s;
    }

    .btn-cancel:hover {
        background: #cbd5e1;
    }

    .btn-confirm {
        background: var(--of-danger);
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 13px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .btn-confirm:hover {
        background: #b91c1c;
    }

    /* â”€â”€ Page wrapper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .order-page {
        padding: 20px;
        max-width: 1600px;
        margin: 0 auto;
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        color: var(--of-text);
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .order-header {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        padding: 32px 36px;
        border-radius: 20px;
        margin-bottom: 32px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
        box-shadow: 0 10px 30px rgba(79, 70, 229, 0.25);
    }

    .order-header h1 {
        margin: 0;
        font-size: 30px;
        font-weight: 800;
        letter-spacing: -0.5px;
    }

    .order-number {
        background: rgba(255, 255, 255, 0.18);
        padding: 8px 18px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 700;
        min-width: auto;
        text-align: center;
        border: 1px solid rgba(255,255,255,0.25);
    }

    /* â”€â”€ Main grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main-grid {
        display: grid;
        grid-template-columns: 380px 1fr;
        gap: 24px;
        margin-top: 20px;
    }

    .left-controls {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    /* â”€â”€ Control cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .control-box {
        background: white;
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        border: 1px solid var(--of-border);
        border-left: 5px solid var(--of-primary);
        position: relative;
    }

    .control-box h3 {
        margin: 0 0 18px 0;
        font-size: 12px;
        color: var(--of-muted);
        border-bottom: 1px solid var(--of-border);
        padding-bottom: 14px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.8px;
    }

    /* Active state for barcode input */
    .control-box.is-active {
        border-color: var(--of-primary);
        border-left: 3px solid var(--of-primary);
        box-shadow: 0 0 0 3px rgba(79,70,229,0.12);
    }

    /* â”€â”€ Form elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .form-group {
        margin-bottom: 16px;
    }

    .form-group label {
        display: block;
        font-weight: 700;
        margin-bottom: 8px;
        color: var(--of-muted);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-control {
        width: 100%;
        padding: 13px 16px;
        border: 1.5px solid #cbd5e1;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 500;
        transition: border-color 0.2s, box-shadow 0.2s;
        background: #fff;
        color: var(--of-text);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--of-primary);
        background: white;
        box-shadow: 0 0 0 4px rgba(79,70,229,0.12);
    }

    /* â”€â”€ Finish order button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-finish-order {
        background: var(--of-success);
        color: white;
        padding: 15px 22px;
        font-size: 16px;
        font-weight: 700;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: background 0.2s, box-shadow 0.2s;
        width: 100%;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-finish-order:hover {
        background: #047857;
        box-shadow: 0 4px 16px rgba(5,150,105,0.25);
    }

    /* â”€â”€ Right panel / cart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .right-items {
        background: white;
        padding: 0;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        border: 1px solid var(--of-border);
        overflow: hidden;
    }

    .right-items h2 {
        margin: 0;
        font-size: 14px;
        font-weight: 700;
        color: white;
        background: #1e293b;
        padding: 16px 20px;
        border-bottom: none;
    }

    .items-container {
        padding: 16px;
        max-height: 800px;
        overflow-y: auto;
    }

    .items-container::-webkit-scrollbar {
        width: 6px;
    }

    .items-container::-webkit-scrollbar-track {
        background: #f8fafc;
        border-radius: 6px;
    }

    .items-container::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 6px;
    }

    .items-container::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* â”€â”€ Order item card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .order-item {
        background: white;
        border: 1px solid var(--of-border);
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 12px;
        display: grid;
        grid-template-columns: 1.2fr 0.8fr 1fr;
        gap: 20px;
        align-items: stretch;
    }

    .order-item:hover {
        border-color: var(--of-primary);
    }

    /* LEFT SECTION: Item Info */
    .item-left {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .item-top {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .item-quantity {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: var(--of-primary);
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 700;
        font-size: 13px;
        min-width: 44px;
    }

    .item-name {
        font-size: 15px;
        font-weight: 700;
        color: var(--of-text);
        line-height: 1.3;
    }

    .item-tags {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
        margin-top: 4px;
    }

    .tax-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        font-size: 11px;
        font-weight: 700;
        padding: 4px 10px;
        border-radius: 6px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        width: fit-content;
    }

    .tax-badge.taxable {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
    }

    .tax-badge.no-tax {
        background: #f0fdf4;
        color: #059669;
        border: 1px solid #bbf7d0;
    }

    /* â”€â”€ Detail boxes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .item-details-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 6px;
    }

    .detail-box {
        background: #f8fafc;
        padding: 8px 12px;
        border-radius: 6px;
        border-left: 3px solid var(--of-primary);
    }

    .detail-box:hover {
        background: #f1f5f9;
    }

    .detail-label {
        font-size: 10px;
        color: var(--of-muted);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        margin-bottom: 2px;
    }

    .detail-value {
        font-size: 13px;
        font-weight: 700;
        color: var(--of-text);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* â”€â”€ Price section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .item-price-section {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        height: 100%;
        padding: 8px 0;
        gap: 6px;
    }

    .item-price-label {
        font-size: 10px;
        color: var(--of-muted);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.8px;
    }

    .item-price {
        font-size: 28px;
        font-weight: 800;
        color: var(--of-success);
        line-height: 1;
    }

    .tax-under-price {
        margin-top: 6px;
        font-size: 10px;
        padding: 3px 8px;
    }

    /* â”€â”€ Actions & Barcode (right column) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .item-right {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: flex-end;
    }

    .btn-delete-item {
        background: var(--of-danger);
        color: white;
        padding: 10px 18px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 700;
        transition: background 0.2s;
        white-space: nowrap;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        align-self: flex-end;
        width: 160px;
        justify-content: center;
        gap: 6px;
    }

    .btn-delete-item:hover {
        background: #b91c1c;
    }

    /* â”€â”€ Barcode display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .barcode-display {
        border: none;
        width: 160px;
        box-shadow: none;
        background: #f8fafc;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        border-radius: 8px;
        padding: 8px;
    }

    .barcode-display-label {
        font-size: 10px;
        color: var(--of-primary);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        text-align: center;
        margin-bottom: 2px;
    }

    .barcode-display-full {
        font-size: 12px;
        color: var(--of-muted);
        font-family: 'Courier New', monospace;
        letter-spacing: 0.5px;
        text-align: center;
        margin-bottom: 4px;
    }

    .barcode-display-last6 {
        font-size: 24px;
        font-weight: 800;
        color: var(--of-primary);
        font-family: 'Courier New', monospace;
        letter-spacing: 2px;
        text-align: center;
    }

    /* â”€â”€ Expiry warning badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .expiry-warning {
        display: inline-block;
        font-size: 9px;
        font-weight: 700;
        padding: 3px 7px;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .expiry-warning.good {
        background: #ecfdf5;
        color: #065f46;
    }

    .expiry-warning.warning {
        background: #fffbeb;
        color: #92400e;
    }

    .expiry-warning.critical {
        background: #fef2f2;
        color: #991b1b;
    }

    .expiry-warning.expired {
        background: var(--of-danger);
        color: white;
        animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }

    /* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty-state {
        text-align: center;
        padding: 48px 32px;
        color: var(--of-muted);
    }

    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.4;
    }

    .empty-state p {
        font-size: 14px;
        margin: 0;
        color: var(--of-muted);
    }

    .empty-state p:first-of-type {
        font-weight: 600;
        margin-bottom: 4px;
        font-size: 15px;
    }

    .empty-state p:last-of-type {
        font-size: 12px;
        color: #94a3b8;
        margin-top: 4px;
    }

    .autocomplete-wrapper {
        position: relative;
    }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 1400px) {
        .main-grid {
            grid-template-columns: 1fr;
        }

        .order-item {
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .items-container {
            max-height: none;
        }
    }

    @media (max-width: 768px) {
        .order-header {
            flex-direction: column;
            text-align: center;
            padding: 18px 20px;
        }

        .order-header h1 {
            font-size: 18px;
        }

        .order-number {
            font-size: 12px;
            padding: 6px 14px;
        }

        .main-grid {
            gap: 16px;
        }

        .order-item {
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .item-price {
            font-size: 24px;
        }

        .btn-delete-item {
            width: 100%;
        }
    }

    /* â”€â”€ Active input highlighting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .control-box.is-active h3 {
        border-bottom-color: var(--of-border);
    }

    .control-box.is-active::after {
        content: "";
        position: absolute;
        inset: -1px;
        border-radius: 10px;
        pointer-events: none;
        box-shadow: 0 0 0 3px rgba(79,70,229,0.12);
    }

    /* â”€â”€ Scan hint â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .scan-hint {
        margin-top: 10px;
        font-size: 12px;
        color: var(--of-primary);
        font-weight: 600;
        letter-spacing: 0.3px;
        display: none;
        padding: 8px;
        background: rgba(79,70,229,0.06);
        border-radius: 6px;
        text-align: center;
    }

    .control-box.is-active .scan-hint { display: block; }

    /* â”€â”€ Overflow & stacking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .left-controls,
    .control-box,
    .autocomplete-wrapper {
        overflow: visible;
    }

    .left-controls { position: relative; z-index: 1; }
    .control-box   { position: relative; z-index: 1; }

    .control-box.autocomplete-open { z-index: 100; }

    /* â”€â”€ Autocomplete dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #autocomplete-results {
        display: none;
        position: absolute;
        top: calc(100% + 6px);
        left: 0;
        right: 0;
        z-index: 99999;

        background: #fff;
        border-radius: 8px;
        border: 1px solid var(--of-border);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);

        max-height: 280px;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 4px;
        margin-top: 0;

        opacity: 0;
        transform: translateY(-4px);
        transition: opacity 0.15s ease, transform 0.15s ease;
        pointer-events: none;
    }

    #autocomplete-results.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
    }

    #autocomplete-results::-webkit-scrollbar { width: 4px; }
    #autocomplete-results::-webkit-scrollbar-track { background: transparent; }
    #autocomplete-results::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

    /* Each result row */
    #autocomplete-results button {
        display: flex;
        flex-direction: column;
        width: 100%;
        text-align: left;
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        background: transparent;
        cursor: pointer;
        transition: background 0.15s ease;
        gap: 2px;
    }

    #autocomplete-results button:hover,
    #autocomplete-results button:focus {
        background: #f1f5f9;
        outline: none;
    }

    /* Product name line */
    #autocomplete-results button .ac-name {
        font-size: 14px;
        font-weight: 700;
        color: var(--of-text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Meta line */
    #autocomplete-results button .ac-meta {
        font-size: 12px;
        color: #94a3b8;
        font-weight: 500;
        display: flex;
        gap: 8px;
    }

    #autocomplete-results button .ac-meta span {
        display: flex;
        align-items: center;
        gap: 3px;
    }

    /* Price chip */
    #autocomplete-results button .ac-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    #autocomplete-results button .ac-price {
        font-size: 13px;
        font-weight: 700;
        color: var(--of-success);
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        padding: 3px 8px;
        border-radius: 6px;
        white-space: nowrap;
        flex-shrink: 0;
    }

    /* Divider between items */
    #autocomplete-results button + button {
        border-top: 1px solid var(--of-border);
    }

    /* "No results" message */
    #autocomplete-results .ac-empty {
        padding: 14px 12px;
        text-align: center;
        color: #94a3b8;
        font-size: 12px;
        font-weight: 500;
    }

</style>

<!-- PAGE CONTAINER -->
<div class="order-page">

    <!-- ORDER HEADER -->
    <div class="order-header">
        <h1>ğŸ“¦ Current Order</h1>
        <div class="order-number">#{{ order.order_id }}</div>
    </div>

    <!-- MAIN GRID -->
    <div class="main-grid">

        <!-- LEFT PANEL: CONTROLS -->
        <div class="left-controls">
            
            <!-- Finish Order Button -->
            <form method="post" action="{% url 'submit_order' %}">
                {% csrf_token %}
                <button type="submit" class="btn-finish-order">âœ… Complete Order</button>
            </form>

            <!-- Search Box -->
<div class="control-box" id="search-box">
                <h3>ğŸ” Search Products</h3>
                <div class="form-group autocomplete-wrapper">
                    <label for="name_query">Product Name:</label>
                    <input type="text" id="name_query" class="form-control" autocomplete="off"
                        placeholder="Type product name...">
                    <div id="autocomplete-results"></div>
                </div>
            </div>

            <!-- Barcode Scan Box -->
<div class="control-box" id="scan-box">
                <h3>ğŸ“± Scan Barcode</h3>
                <div class="form-group">
                    <label for="barcode">Barcode:</label>
                    <input type="text" id="barcode" name="barcode" class="form-control"
                        placeholder="Scan here..." autofocus>
                </div>
  <div class="scan-hint">âœ… Ready to scan (cursor is in Barcode)</div>
            </div>

        </div>

        <!-- RIGHT PANEL: ORDER ITEMS -->
<div class="right-items">
  <h2>ğŸ“‹ Order Items</h2>

  <div class="items-container">
    {% if order_items %}
    {% for item in order_items reversed %}
        <div class="order-item">

          <!-- COL 1 -->
          <div class="col-info">
            <div class="item-top">
              <span class="item-quantity">{{ item.quantity }}Ã—</span>
              <span class="item-name">{{ item.product.name }}</span>
            </div>

            <div class="item-details-grid">
              <div class="detail-box">
                <div class="detail-label">Item #</div>
                <div class="detail-value">{{ item.product.item_number }}</div>
              </div>

              <div class="detail-box">
                <div class="detail-label">Stock</div>
                <div class="detail-value">{{ item.product.quantity_in_stock }}</div>
              </div>

              <div class="detail-box">
                <div class="detail-label">Expires</div>
                <div class="detail-value expiry-date"
                     data-expiry="{{ item.product.expiry_date|date:'Y-m-d' }}">
                    {{ item.product.expiry_date|default:"N/A" }}
                </div>
              </div>
            </div>
          </div>

          <!-- COL 2 -->
          <div class="col-price item-price-section">
            <div class="item-price-label">Price</div>
            <div class="item-price">${{ item.product.price|floatformat:2 }}</div>

            {% if item.product.taxable %}
              <span class="tax-badge taxable tax-under-price">ğŸ”´ Taxable</span>
            {% else %}
              <span class="tax-badge no-tax tax-under-price">ğŸŸ¢ Tax Free</span>
            {% endif %}
          </div>

          <!-- COL 3 -->
          <div class="col-actions item-right">
            <form method="post" action="{% url 'delete_order_item' item.product.product_id %}">
              {% csrf_token %}
              <button type="submit" class="btn-delete-item">ğŸ—‘ï¸ Delete</button>
            </form>

            <div class="barcode-display">
              <div class="barcode-display-label">Barcode</div>
              <div class="barcode-display-full">{{ item.product.barcode }}</div>
              <div class="barcode-display-last6">
                {{ item.product.barcode|slice:"-6:" }}
              </div>
            </div>
          </div>

        </div>
      {% endfor %}
    {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ›’</div>
        <p>No items in order</p>
        <p>Scan a barcode or search to add items</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- expiry pop up -->
<div id="expiry-confirm-modal" style="display:none;">
  <div class="expiry-modal-backdrop"></div>
  <div class="expiry-modal">
    <h2>âš ï¸ Expired Product</h2>
    <p id="expiry-modal-message"></p>

    <div class="expiry-modal-actions">
      <button id="expiry-cancel" class="btn-cancel">Cancel</button>
      <button id="expiry-confirm" class="btn-confirm">Add Anyway</button>
    </div>
  </div>
</div>

<div id="inactive-confirm-modal" style="display:none;">
    <div class="expiry-modal-backdrop"></div>
    <div class="expiry-modal">
      <h2 style="color: #f39c12;">âš ï¸ Inactive Product</h2>
      <p id="inactive-modal-message"></p>
      <div class="expiry-modal-actions">
        <button id="inactive-cancel" class="btn-cancel">Cancel</button>
        <button id="inactive-confirm" class="btn-confirm" style="background: #f39c12;">âœ… Activate & Add</button>
      </div>
    </div>
  </div>


{{ all_products|json_script:"products-json" }}

<!-- ===================== SCRIPTS ===================== -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const barcodeInput     = document.getElementById('barcode');
    const searchInput      = document.getElementById('name_query');
    const products         = JSON.parse(document.getElementById('products-json').textContent.trim());
    const searchBox        = document.getElementById('search-box');
    const resultsContainer = document.getElementById('autocomplete-results');

    const expiryModal    = document.getElementById('expiry-confirm-modal');
    const expiryMsg      = document.getElementById('expiry-modal-message');
    const btnExpiryCancel  = document.getElementById('expiry-cancel');
    const btnExpiryConfirm = document.getElementById('expiry-confirm');

    const inactiveModal    = document.getElementById('inactive-confirm-modal');
    const inactiveMsg      = document.getElementById('inactive-modal-message');
    const btnInactiveCancel  = document.getElementById('inactive-cancel');
    const btnInactiveConfirm = document.getElementById('inactive-confirm');

    let pendingProduct = null;
    let locked = false;

    // Normalize barcode by removing leading zeros (match backend behavior)
    function normalizeBarcode(barcode) {
        if (!barcode) return '';
        const str = barcode.toString().trim();
        // Remove leading zeros: "065656912886" â†’ "65656912886"
        return str.replace(/^0+/, '') || '0';
    }

    function refocusBarcode() {
        if (document.activeElement === searchInput) return;
        if (expiryModal.style.display === 'block' || inactiveModal.style.display === 'block') return;
        if (barcodeInput && document.activeElement !== barcodeInput) {
            barcodeInput.focus();
        }
    }

    function finalizeAdd(product, overrideExpiry = false, overrideInactive = false) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = product.barcode ? "{% url 'create_order' %}" : `/add-product/${product.product_id}/`;
        form.classList.add('claude-created-form'); // â† Mark as allowed

        const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
        let html = `<input type="hidden" name="csrfmiddlewaretoken" value="${csrf}">`;
        html += `<input type="hidden" name="quantity" value="1">`;

        if (product.barcode)  html += `<input type="hidden" name="barcode" value="${product.barcode}">`;
        if (overrideExpiry)   html += `<input type="hidden" name="override_expiry" value="1">`;
        if (overrideInactive) html += `<input type="hidden" name="override_inactive" value="1">`;

        form.innerHTML = html;
        document.body.appendChild(form);
        form.submit();
    }

    function validateAndAdd(product) {
        pendingProduct = product;

        // Check for inactive: false, 0, null, undefined, "false", "0"
        const isInactive = product.status === false || 
                          product.status === 0 || 
                          product.status === null || 
                          product.status === undefined ||
                          product.status === "false" ||
                          product.status === "0";

        if (isInactive) {
            locked = true;
            inactiveMsg.innerHTML = `<strong>${product.name}</strong> is currently <strong>Inactive</strong>.<br><br>
                Clicking <em>Activate &amp; Add</em> will set it as Active and add it to the order.`;
            
            // Show modal
            inactiveModal.style.setProperty('display', 'block', 'important');
            return;
        }

        // Product is active, check expiry
        checkExpiry(product, false);
    }

    function checkExpiry(product, inactiveWasOverridden = false) {
        if (!product.expiry_date) {
            return finalizeAdd(product, false, inactiveWasOverridden);
        }

        const today = new Date(); today.setHours(0, 0, 0, 0);
        const expiryDate = new Date(product.expiry_date);

        if (expiryDate < today) {
            locked = true;
            pendingProduct._inactiveOverridden = inactiveWasOverridden;
            expiryMsg.innerHTML = `<strong>${product.name}</strong> is expired (Expiry: ${product.expiry_date}).<br><br>Add anyway?`;
            expiryModal.style.setProperty('display', 'block', 'important');
        } else {
            finalizeAdd(product, false, inactiveWasOverridden);
        }
    }

    btnInactiveCancel.onclick = () => {
        inactiveModal.style.setProperty('display', 'none', 'important');
        locked = false; pendingProduct = null; refocusBarcode();
    };
    
    btnInactiveConfirm.onclick = () => {
        inactiveModal.style.setProperty('display', 'none', 'important');
        checkExpiry(pendingProduct, true);
    };

    btnExpiryCancel.onclick = () => {
        expiryModal.style.setProperty('display', 'none', 'important');
        locked = false; pendingProduct = null; refocusBarcode();
    };
    
    btnExpiryConfirm.onclick = () => {
        const inactiveWasOverridden = (pendingProduct && pendingProduct._inactiveOverridden) || false;
        finalizeAdd(pendingProduct, true, inactiveWasOverridden);
    };

    let scanDebounceTimer = null;

    // Capture ALL events on the barcode input - even before they bubble
    barcodeInput.addEventListener('keydown', e => {
        // Only process Enter key
        if (e.key !== 'Enter') return;

        // IMMEDIATELY block everything
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        // If modal is open, do nothing
        if (locked) return;

        // Process IMMEDIATELY
        const code = barcodeInput.value.trim();
        if (!code) return;

        // Normalize the scanned barcode (remove leading zeros)
        const normalizedCode = normalizeBarcode(code);
        
        // Find product using normalized comparison
        const product = products.find(p => {
            if (!p.barcode) return false;
            const normalizedDB = normalizeBarcode(p.barcode);
            return normalizedDB === normalizedCode;
        });
        
        if (product) {
            validateAndAdd(product);
        } else {
            // Unknown barcode - submit to backend
            finalizeAdd({barcode: code});
        }

        barcodeInput.value = '';
    }, true); // â† USE CAPTURE PHASE to catch event before anything else

    searchInput.addEventListener('input', function () {
        const query = searchInput.value.trim().toLowerCase();
        resultsContainer.innerHTML = '';

        if (query.length < 2) {
            resultsContainer.classList.remove('active');
            searchBox.classList.remove('autocomplete-open');
            return;
        }

        const matches = products.filter(p => p.name.toLowerCase().includes(query)).slice(0, 10);

        if (matches.length === 0) {
            resultsContainer.innerHTML = '<div class="ac-empty">No products found</div>';
            resultsContainer.classList.add('active');
            searchBox.classList.add('autocomplete-open');
            return;
        }

        matches.forEach(p => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.innerHTML = `
                <div class="ac-row">
                    <span class="ac-name">${p.name}</span>
                    <span class="ac-price">$${parseFloat(p.price).toFixed(2)}</span>
                </div>
                <div class="ac-meta">
                    <span>ğŸ“¦ ${p.item_number || 'â€”'}</span>
                    <span>ğŸ· ${p.quantity_in_stock} in stock</span>
                </div>`;
            btn.onclick = () => {
                resultsContainer.classList.remove('active');
                searchBox.classList.remove('autocomplete-open');
                searchInput.value = '';
                validateAndAdd(p);
            };
            resultsContainer.appendChild(btn);
        });

        resultsContainer.classList.add('active');
        searchBox.classList.add('autocomplete-open');
    });

    document.addEventListener('click', e => {
        if (!e.target.closest('#name_query') && !e.target.closest('#autocomplete-results')) {
            resultsContainer.classList.remove('active');
            searchBox.classList.remove('autocomplete-open');
        }
        if (!e.target.closest('a, button, input, select, textarea, .autocomplete-item')) {
            refocusBarcode();
        }
    });

    document.querySelectorAll('.expiry-date').forEach(el => {
        const expiryDateStr = el.dataset.expiry;
        if (!expiryDateStr || expiryDateStr === 'None') return;
        const expiryDate = new Date(expiryDateStr);
        const today = new Date(); today.setHours(0, 0, 0, 0);
        const daysDiff = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
        const badge = document.createElement('span');
        badge.className = 'expiry-warning';
        if      (daysDiff < 0)   { badge.classList.add('expired');  badge.innerHTML = 'âŒ Expired'; }
        else if (daysDiff <= 30) { badge.classList.add('critical'); badge.innerHTML = `ğŸŸ  ${daysDiff}d`; }
        else                     { badge.classList.add('good');     badge.innerHTML = `ğŸŸ¢ ${Math.floor(daysDiff/30)}m`; }
        el.appendChild(badge);
    });

    refocusBarcode();
});
</script>




{% endblock %}