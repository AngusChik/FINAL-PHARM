{% extends 'base.html' %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
  /* =========================================================
     1. Design System (Synced with Add Product)
     ========================================================= */
  :root {
    --np-primary: #4f46e5;
    --np-secondary: #667eea;
    --np-success: #10b981;
    --np-danger: #ef4444;
    --np-bg: #f8fafc;
    --np-border: #e2e8f0;
    --np-text-main: #1e293b;
    --np-text-muted: #64748b;
  }

  .checkin-page { 
    padding: 24px; max-width: 1600px; margin: 0 auto; 
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    color: var(--np-text-main);
    background-color: var(--np-bg);
  }

  /* --- Header --- */
  .order-header {
    background: linear-gradient(135deg, var(--np-primary) 0%, #7c3aed 100%);
    color: #fff; padding: 32px; border-radius: 24px; margin-bottom: 30px;
    box-shadow: 0 10px 25px rgba(79, 70, 229, 0.2);
    display: flex; justify-content: space-between; align-items: center;
  }
  .order-header h1 { margin: 0; font-size: 34px; font-weight: 800; letter-spacing: -1px; }
  .page-subtitle { margin-top: 4px; font-size: 14px; opacity: 0.9; }

  /* --- Layout Grid --- */
  .main-grid { display: grid; grid-template-columns: 380px 1fr; gap: 32px; }
  @media (max-width: 1100px) { .main-grid { grid-template-columns: 1fr; } }

  /* --- Cards & Control Boxes --- */
  .control-box, .product-card {
    background: #fff; border-radius: 20px; 
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03); 
    border: 1px solid var(--np-border);
    margin-bottom: 24px;
    position: relative;
    overflow: visible !important; /* ‚úÖ Prevents dropdown clipping */
  }

  .control-box { padding: 24px; border-left: 6px solid var(--np-primary); transition: all 0.3s ease; }
  
  /* Lift card z-index when any child is focused */
  .control-box:focus-within { 
    z-index: 5000 !important; 
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  }

  .control-box h3, .product-card-header h3 {
    margin: 0 0 20px 0; font-size: 13px; font-weight: 800; 
    text-transform: uppercase; color: var(--np-text-muted); letter-spacing: 1px;
    border-bottom: 1px solid var(--np-border); padding-bottom: 12px;
  }

  /* --- Inputs & Forms --- */
  .form-control {
    width: 100%; padding: 12px 16px; border: 2px solid var(--np-border); border-radius: 12px;
    font-size: 15px; transition: all 0.2s; background: #fff; color: #000;
  }
  .form-control:focus { 
    outline: none; border-color: var(--np-primary); 
    box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); 
  }

  /* --- Autocomplete Dropdown --- */
  #autocomplete-results {
    display: none; position: absolute; top: 100%; left: 0; right: 0;
    z-index: 10000 !important; background: #fff;
    border-radius: 14px; border: 1px solid var(--np-border);
    box-shadow: 0 15px 35px rgba(0,0,0,0.15); margin-top: 8px;
    max-height: 320px; overflow-y: auto;
  }
  #autocomplete-results.active { display: block; }
  .autocomplete-item { 
    width: 100%; text-align: left; padding: 14px 18px; background: none; 
    border: none; border-bottom: 1px solid #f1f5f9; cursor: pointer;
    transition: background 0.2s;
  }
  .autocomplete-item:hover { background: #f5f7ff; }
  .autocomplete-item strong { color: var(--np-primary); font-size: 14px; }

  /* --- Details Grid & Inline Edit --- */
  .product-card-header { 
    padding: 24px 28px; background: #fcfcfd; border-bottom: 1px solid var(--np-border); 
    display: flex; justify-content: space-between; align-items: center; 
  }
  .product-name { font-size: 24px; font-weight: 800; color: #0f172a; }

  .checkin-details-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; padding: 28px; }
  .detail-box { background: #fff; padding: 16px; border-radius: 12px; border: 1px solid var(--np-border); transition: all 0.2s; }
  .detail-label { font-size: 10px; font-weight: 800; text-transform: uppercase; color: var(--np-text-muted); margin-bottom: 8px; }
  .detail-value { font-size: 15px; font-weight: 700; color: var(--np-text-main); }
  
  /* Inline Edit Styles */
  .view-mode { display: block; }
  .edit-mode { display: none; }
  .inline-edit-form.is-editing .view-mode { display: none !important; }
  .inline-edit-form.is-editing .edit-mode { display: block !important; }
  .inline-edit-form.is-editing .detail-box { border-color: var(--np-primary); background: #fcfdff; }
  .edit-mode input, .edit-mode select { width: 100%; padding: 8px; border: 2px solid var(--np-primary); border-radius: 8px; font-weight: 700; }

  /* --- Stock Control UI --- */
  .stock-control-group { display: inline-flex; align-items: center; background: #f1f5f9; padding: 6px; border-radius: 16px; border: 1px solid var(--np-border); gap: 10px; }
  .stock-display-chip { background: #fff; padding: 10px 20px; border-radius: 12px; min-width: 110px; text-align: center; border: 1px solid var(--np-border); }
  .stock-display-chip .label { display: block; font-size: 9px; text-transform: uppercase; color: var(--np-text-muted); font-weight: 800; margin-bottom: 2px; }
  .stock-display-chip .value { font-size: 20px; font-weight: 900; color: var(--np-primary); }
  
  .btn-stock-adj { 
    width: 46px; height: 46px; border-radius: 12px; border: none; cursor: pointer; 
    font-size: 20px; font-weight: 900; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex; align-items: center; justify-content: center;
  }
  .btn-stock-minus { background: #fee2e2; color: #dc2626; }
  .btn-stock-minus:hover { background: #fecaca; transform: scale(1.08); }
  .btn-stock-plus { background: #dcfce7; color: #16a34a; }
  .btn-stock-plus:hover { background: #bbf7d0; transform: scale(1.08); }

  /* --- Scan Hint --- */
  .scan-hint { 
    display: none; color: var(--np-success); font-size: 13px; font-weight: 800; 
    margin-top: 12px; align-items: center; gap: 6px;
  }
  #scan-box:focus-within .scan-hint { display: flex; animation: hintPulse 2s infinite; }
  @keyframes hintPulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

  /* --- Generic Buttons --- */
  .btn-action {
    border: none; border-radius: 12px; padding: 12px 20px; font-weight: 700; cursor: pointer;
    transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;
    text-decoration: none; font-size: 14px;
  }
  .btn-soft { background: rgba(255, 255, 255, 0.15); color: #fff; border: 1px solid rgba(255, 255, 255, 0.2); }
  .btn-soft:hover { background: rgba(255, 255, 255, 0.25); transform: translateY(-1px); }
  .btn-edit-toggle { background: #f8fafc; color: #475569; border: 1px solid var(--np-border); }
  .btn-edit-toggle:hover { background: #f1f5f9; }

  /* üìÖ Flatpickr Icons */
  .flatpickr-date {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236366f1' viewBox='0 0 16 16'%3E%3Cpath d='M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 14px center; padding-right: 44px !important;
  }
</style>

<div class="checkin-page">
  <div class="order-header">
    <div class="header-left">
      <h1>üì• Check-in</h1>
      <div class="page-subtitle">Inventory management and restocking hub.</div>
    </div>
    <form method="get" action="{% url 'new_product' %}">
      <input type="hidden" name="next" value="{{ request.path }}">
      <button type="submit" class="btn-action btn-soft">Ôºã New Product</button>
    </form>
  </div>

  <div class="main-grid">
    <div class="left-controls">
      <div class="control-box">
        <h3>üîç Search Products</h3>
        <div class="form-group autocomplete-wrapper">
          <label class="detail-label" for="name_query">Product Name</label>
          <input type="text" id="name_query" class="form-control" autocomplete="off" placeholder="Start typing name...">
          <div id="autocomplete-results"></div>
        </div>
      </div>

      <div class="control-box" id="scan-box">
        <h3>üì± Barcode Scanner</h3>
        <form id="barcodeForm" method="post" action="{% url 'checkin' %}">
          {% csrf_token %}
          <div class="form-group">
            <label class="detail-label" for="barcode">Scanning Field</label>
            <input type="text" id="barcode" name="barcode" class="form-control" autofocus placeholder="Ready for barcode...">
          </div>
        </form>
        <div class="scan-hint"><span>‚úÖ</span> Scanner is active</div>
      </div>
    </div>

    <div class="right-items">
      <div class="product-card">
        {% if product %}
          <div class="product-card-header">
            <div>
              <div class="product-name">{{ product.name }}</div>
              <div class="product-sub">Item Number: <strong>{{ product.item_number }}</strong></div>
            </div>
            <button type="button" class="btn-action btn-edit-toggle" id="toggleEditBtn">‚úèÔ∏è Edit Details</button>
          </div>

          <div style="padding: 28px; border-top: 1px solid var(--np-border); background: #fcfcfd;">
              <div class="detail-label" style="margin-bottom: 12px;">Fast Inventory Adjust</div>
              <div class="stock-control-group">
                  <form method="post" action="{% url 'delete_one' product.product_id %}">
                      {% csrf_token %}<button type="submit" class="btn-stock-adj btn-stock-minus">Ôºç</button>
                  </form>
                  <div class="stock-display-chip">
                    <span class="label">Units in Stock</span>
                    <span class="value">{{ product.quantity_in_stock }}</span>
                  </div>
                  <form method="post" action="{% url 'add_quantity' product.product_id %}">
                      {% csrf_token %}<input type="hidden" name="amount" value="1">
                      <button type="submit" class="btn-stock-adj btn-stock-plus">Ôºã</button>
                  </form>
              </div>
          </div>
          
          <form method="post" action="{% url 'checkin_edit_product' product.product_id %}" class="inline-edit-form" id="inlineEditForm">
            {% csrf_token %}
            {{ edit_form.name.as_hidden }} {{ edit_form.brand.as_hidden }} {{ edit_form.quantity_in_stock.as_hidden }} {{ edit_form.price_per_unit.as_hidden }}

            <div class="checkin-details-grid">
              <div class="detail-box">
                <div class="detail-label">Internal ID</div>
                <div class="detail-value view-mode">{{ product.item_number }}</div>
                <div class="edit-mode">{{ edit_form.item_number }}</div>
              </div>
              <div class="detail-box">
                <div class="detail-label">Barcode / UPC</div>
                <div class="detail-value view-mode">{{ product.barcode|default:"‚Äî" }}</div>
                <div class="edit-mode">{{ edit_form.barcode }}</div>
              </div>
              <div class="detail-box">
                <div class="detail-label">Retail Price</div>
                <div class="detail-value view-mode">${{ product.price|floatformat:2 }}</div>
                <div class="edit-mode">{{ edit_form.price }}</div>
              </div>
              <div class="detail-box">
                <div class="detail-label">Expiry Date</div>
                <div class="detail-value view-mode">{% if product.expiry_date %}{{ product.expiry_date|date:"d-m-Y" }}{% else %}N/A{% endif %}</div>
                <div class="edit-mode">{{ edit_form.expiry_date }}</div>
              </div>
              <div class="detail-box">
                <div class="detail-label">Category</div>
                <div class="detail-value view-mode">{{ product.category.name|default:"‚Äî" }}</div>
                <div class="edit-mode">{{ edit_form.category }}</div>
              </div>
              <div class="detail-box">
                <div class="detail-label">Market Status</div>
                <div class="detail-value view-mode">
                  <span class="status-pill {% if product.status %}active{% else %}inactive{% endif %}">
                    {% if product.status %}ACTIVE{% else %}INACTIVE{% endif %}
                  </span>
                </div>
                <div class="edit-mode">{{ edit_form.status }} Product Active</div>
              </div>
            </div>
            <div class="checkin-details-grid">
  <div class="detail-box important">
    <div class="detail-label">Tax Status</div>
    <div class="detail-value view-mode">
      <span class="status-pill {% if product.taxable %}active{% else %}inactive{% endif %}">
        {{ product.taxable|yesno:"TAXABLE,EXEMPT" }}
      </span>
    </div>
    <div class="edit-mode">
      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px 0;">
        {{ edit_form.taxable }} <span style="font-size: 13px; font-weight: 700;">Apply Sales Tax</span>
      </label>
    </div>
  </div>

 
            <div class="edit-actions" id="inlineEditActions" style="display:none; padding: 0 28px 28px;">
              <button type="button" class="btn-action btn-edit-toggle" id="cancelInlineEdit">Cancel</button>
              <button type="submit" class="btn-action" style="background:var(--np-primary); color:#fff;">üíæ Save Updates</button>
            </div>
          </form>

        {% else %}
          <div style="text-align:center; padding: 120px 40px; color: var(--np-text-muted);">
            <div style="font-size: 64px; margin-bottom: 24px; opacity: 0.5;">üì¶</div>
            <p style="font-weight: 800; font-size: 20px; color: var(--np-text-main);">No Item Selected</p>
            <p style="font-size: 14px;">Scan a product or use the search bar on the left to begin.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{{ all_products|json_script:"products-json" }}

<script>
document.addEventListener('DOMContentLoaded', function () {
    const barcodeInput = document.getElementById('barcode');
    const searchInput = document.getElementById('name_query');
    const inlineForm = document.getElementById('inlineEditForm');
    const resultsContainer = document.getElementById('autocomplete-results');
    const editBtn = document.getElementById('toggleEditBtn');
    const editActions = document.getElementById('inlineEditActions');
    
    let idleTimer;

    // --- 1. CORE FUNCTION: UNCONDITIONAL REFOCUS ---
    const forceScannerFocus = () => {
        if (barcodeInput && document.activeElement !== barcodeInput) {
            barcodeInput.focus();
        }
    };

    // --- 2. IDLE TIMER & TRIGGERS ---
    const resetIdleTimer = () => {
        clearTimeout(idleTimer);
        idleTimer = setTimeout(forceScannerFocus, 3000); 
    };

    if (barcodeInput) {
        barcodeInput.focus(); 
        ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(evt => 
            document.addEventListener(evt, resetIdleTimer)
        );
        document.addEventListener('click', (e) => {
            if (!['INPUT', 'SELECT', 'TEXTAREA', 'BUTTON', 'A'].includes(e.target.tagName)) {
                forceScannerFocus();
            }
        });
        searchInput?.addEventListener('blur', () => {
            setTimeout(forceScannerFocus, 200); 
        });
    }

    // --- 3. SEARCH & DROPDOWN LOGIC ---
    if (searchInput) {
        // 1. Get the JSON data safely
        const productsJson = document.getElementById('products-json');
        if (!productsJson) {
            console.error("Error: 'products-json' script tag not found.");
            return;
        }

        const products = JSON.parse(productsJson.textContent.trim());

        searchInput.addEventListener('input', function () {
            const query = this.value.trim().toLowerCase();
            resultsContainer.innerHTML = '';
            
            if (query.length < 2) { 
                resultsContainer.classList.remove('active'); 
                return; 
            }

            // 2. Filter logic: check Name, Barcode, or Item Number
            const matches = products.filter(p => {
                const nameMatch = p.name ? p.name.toLowerCase().includes(query) : false;
                const barcodeMatch = p.barcode ? String(p.barcode).toLowerCase().includes(query) : false;
                const itemNumMatch = p.item_number ? String(p.item_number).toLowerCase().includes(query) : false;
                
                return nameMatch || barcodeMatch || itemNumMatch;
            }).slice(0, 8);

            // 3. Render Results
            if (matches.length > 0) {
                resultsContainer.classList.add('active');
                matches.forEach(p => {
                    const btn = document.createElement('button');
                    btn.className = 'autocomplete-item'; 
                    btn.type = 'button';
                    
                    // Determine if it was a barcode match for the badge
                    const isBarcodeMatch = p.barcode && String(p.barcode).toLowerCase().includes(query);
                    const badgeText = isBarcodeMatch ? 'BC Match' : 'Name Match';

                    btn.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>${p.name}</strong>
                            <span style="font-size: 10px; background: #eef2ff; color: #4f46e5; padding: 2px 6px; border-radius: 4px;">
                                ${badgeText}
                            </span>
                        </div>
                        <small style="display:block; color:#64748b; font-size:11px;">
                            SKU: ${p.item_number} | BC: ${p.barcode || 'N/A'} | Stock: ${p.quantity_in_stock}
                        </small>`;
                    
                    btn.onclick = (e) => {
                        e.preventDefault();
                        const f = document.createElement('form'); 
                        f.method = 'POST'; 
                        f.action = `/checkin/add/${p.product_id}/`;
                        const token = document.querySelector('[name=csrfmiddlewaretoken]').value;
                        f.innerHTML = `
                            <input type="hidden" name="csrfmiddlewaretoken" value="${token}">
                            <input type="hidden" name="quantity" value="1">
                        `;
                        document.body.appendChild(f); 
                        f.submit();
                    };
                    resultsContainer.appendChild(btn);
                });
            } else { 
                resultsContainer.classList.remove('active'); 
            }
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => { 
            if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
                resultsContainer.classList.remove('active');
            }
        });
    }

    // --- 4. INLINE EDIT & DATE LOGIC ---
    if (editBtn && inlineForm) {
        editBtn.addEventListener('click', () => { 
            inlineForm.classList.add('is-editing'); 
            editActions.style.display = 'flex'; 
            editBtn.style.display = 'none'; 
        });
        document.getElementById('cancelInlineEdit')?.addEventListener('click', () => window.location.reload());
    }

    const expiryInput = document.querySelector('.flatpickr-date');
    if (expiryInput) {
        flatpickr(expiryInput, { dateFormat: "d-m-Y", allowInput: true, monthSelectorType: "static" });
        expiryInput.addEventListener('input', function() {
            let val = this.value.replace(/\D/g, ''); let out = '';
            if (val.length > 0) { 
                out += val.substring(0, 2); 
                if (val.length > 2) out += '-' + val.substring(2, 4); 
                if (val.length > 4) out += '-' + val.substring(4, 8); 
            }
            this.value = out.substring(0, 10);
        });
    }

    // --- 5. TOASTS ---
    document.querySelectorAll('.toast-msg').forEach(t => {
        setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 4000);
        t.querySelector('.toast-close')?.addEventListener('click', () => t.remove());
    });
});
</script>
{% endblock %}