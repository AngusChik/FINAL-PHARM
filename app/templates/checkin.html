{% extends 'base.html' %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
  /* =========================================================
     1. Modern Design System & Variables
     ========================================================= */
  :root {
    --bg-app: #f4f4f5;
    --surface: #ffffff;
    --surface-hover: #f8fafc;
    --border-subtle: #e4e4e7;
    --border-focus: #a5b4fc;
    
    --text-primary: #0f172a;
    --text-secondary: #64748b;
    
    --brand-primary: #4f46e5;
    --brand-primary-hover: #4338ca;
    
    --success-bg: #ecfdf5;
    --success-text: #047857;
    --success-border: #6ee7b7;
    
    --danger-bg: #fef2f2;
    --danger-text: #b91c1c;
    --danger-border: #fca5a5;

    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-full: 9999px;
    
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --shadow-float: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
  }

  .checkin-page { 
    padding: 2rem 1.5rem; 
    max-width: 1280px; 
    margin: 0 auto; 
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    color: var(--text-primary);
  }

  /* --- Header --- */
  .order-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    padding-bottom: 1.5rem;
    margin-bottom: 2rem;
    border-bottom: 1px solid var(--border-subtle);
  }
  .header-left h1 { 
    margin: 0 0 0.25rem 0; 
    font-size: 2rem; 
    font-weight: 700; 
    letter-spacing: -0.025em; 
    color: var(--text-primary);
  }
  .page-subtitle { 
    font-size: 0.95rem; 
    color: var(--text-secondary); 
    font-weight: 500;
  }

  /* --- Layout Grid --- */
  .main-grid { 
    display: grid; 
    grid-template-columns: 360px 1fr; 
    gap: 2rem; 
    align-items: start;
  }
  @media (max-width: 992px) { .main-grid { grid-template-columns: 1fr; } }

  /* --- Cards & Control Boxes --- */
  .control-box, .product-card {
    background: var(--surface); 
    border-radius: var(--radius-lg); 
    box-shadow: var(--shadow-sm); 
    border: 1px solid var(--border-subtle);
    margin-bottom: 1.5rem;
    position: relative;
    overflow: visible !important;
    transition: box-shadow 0.2s ease, transform 0.2s ease;
  }

  .control-box { padding: 1.5rem; }
  .control-box:focus-within { 
    z-index: 50; 
    box-shadow: var(--shadow-md);
    border-color: var(--border-focus);
  }

  .control-box h3, .product-card-header h3 {
    margin: 0 0 1rem 0; 
    font-size: 0.85rem; 
    font-weight: 700; 
    text-transform: uppercase; 
    color: var(--text-secondary); 
    letter-spacing: 0.05em;
  }

  /* --- Inputs & Forms --- */
  .form-group { position: relative; }
  .detail-label { 
    display: block;
    font-size: 0.8rem; 
    font-weight: 600; 
    text-transform: uppercase; 
    color: var(--text-secondary); 
    margin-bottom: 0.5rem; 
    letter-spacing: 0.025em;
  }
  
  .form-control {
    width: 100%; 
    padding: 0.75rem 1rem; 
    border: 1px solid var(--border-subtle); 
    border-radius: var(--radius-md);
    font-size: 0.95rem; 
    transition: all 0.2s; 
    background: var(--surface); 
    color: var(--text-primary);
  }
  .form-control:focus { 
    outline: none; 
    border-color: var(--brand-primary); 
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15); 
  .form-control:focus {
    outline: none; border-color: var(--np-primary);
    box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
  }

  /* --- Autocomplete Dropdown --- */
  #autocomplete-results {
    display: none; position: absolute; top: calc(100% + 4px); left: 0; right: 0;
    z-index: 100; background: var(--surface);
    border-radius: var(--radius-md); border: 1px solid var(--border-subtle);
    box-shadow: var(--shadow-float); 
    max-height: 300px; overflow-y: auto;
  }
  #autocomplete-results.active { display: block; }
  .autocomplete-item { 
    width: 100%; text-align: left; padding: 0.875rem 1rem; background: none; 
    border: none; border-bottom: 1px solid var(--bg-app); cursor: pointer;
    transition: background 0.15s;
  }
  .autocomplete-item:last-child { border-bottom: none; }
  .autocomplete-item:hover { background: var(--surface-hover); }
  .autocomplete-item strong { color: var(--text-primary); font-size: 0.95rem; font-weight: 600; }

  /* --- Details Grid & Inline Edit --- */
  .product-card { padding: 0; overflow: hidden !important; }
  .product-card-header { 
    padding: 1.5rem; 
    background: var(--surface); 
    border-bottom: 1px solid var(--border-subtle); 
    display: flex; justify-content: space-between; align-items: flex-start; 
  }
  .product-name { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.25rem; letter-spacing: -0.025em;}
  .product-sub { font-size: 0.9rem; color: var(--text-secondary); }

  .checkin-details-grid { 
    display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
    gap: 1.5rem; padding: 1.5rem; 
    border-bottom: 1px solid var(--border-subtle);
  }
  .checkin-details-grid:last-child { border-bottom: none; }

  .detail-box { 
    display: flex; flex-direction: column; gap: 0.25rem;
  }
  .detail-value { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }

  /* ‚îÄ‚îÄ Status Pill ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .status-pill {
    display: inline-flex; align-items: center; gap: 0.5rem;
    font-size: 0.75rem; font-weight: 700; letter-spacing: 0.05em;
    text-transform: uppercase; padding: 0.25rem 0.75rem;
    border-radius: var(--radius-full); white-space: nowrap;
  }
  .status-pill::before {
    content: ''; display: inline-block;
    width: 6px; height: 6px; border-radius: 50%;
  }
  .status-pill.active { background: var(--success-bg); color: var(--success-text); border: 1px solid var(--success-border); }
  .status-pill.active::before { background: #10b981; animation: activePulse 2s ease-in-out infinite; }
  .status-pill.inactive { background: var(--danger-bg); color: var(--danger-text); border: 1px solid var(--danger-border); }
  .status-pill.inactive::before { background: #ef4444; }

  @keyframes activePulse {
    0%, 100% { box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
    50%       { box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.05); }
  }

  /* ‚îÄ‚îÄ Market Status Detail Box ‚îÄ‚îÄ */
  .detail-box.status-box {
    grid-column: 1 / -1;
    flex-direction: row; align-items: center; justify-content: space-between;
    padding: 1rem 1.25rem; border-radius: var(--radius-md); border: 1px solid var(--border-subtle);
    background: var(--surface-hover);
  }
  .detail-box.status-box.is-active { background: var(--success-bg); border-color: var(--success-border); }
  .detail-box.status-box.is-inactive { background: var(--danger-bg); border-color: var(--danger-border); }
  
  /* --- Inline Edit Styles --- */
  .view-mode { display: block; }
  .edit-mode { display: none; }
  .inline-edit-form.is-editing .view-mode { display: none !important; }
  .inline-edit-form.is-editing .edit-mode { display: block !important; }
  
  .edit-mode input, .edit-mode select { 
    width: 100%; padding: 0.5rem; 
    border: 1px solid var(--border-focus); 
    border-radius: 6px; 
    font-weight: 500; 
    font-size: 0.95rem;
    background: #fff;
  }
  .edit-mode input:focus, .edit-mode select:focus {
    outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
  }

  /* --- Stock Control UI --- */
  .stock-control-group { display: inline-flex; align-items: center; background: #f1f5f9; padding: 6px; border-radius: 16px; border: 1px solid var(--np-border); gap: 10px; }
  .stock-display-chip { background: #fff; padding: 10px 20px; border-radius: 12px; min-width: 110px; text-align: center; border: 1px solid var(--np-border); }
  .stock-display-chip .label { display: block; font-size: 9px; text-transform: uppercase; color: var(--np-text-muted); font-weight: 800; margin-bottom: 2px; }
  .stock-display-chip .value { font-size: 24px; font-weight: 900; color: var(--np-primary); }
  
  .btn-stock-adj {
    width: 52px; height: 52px; border-radius: 12px; border: none; cursor: pointer;
    font-size: 22px; font-weight: 900; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
  }
  .btn-stock-minus { background: var(--danger-bg); color: var(--danger-text); }
  .btn-stock-minus:hover { background: #fecaca; }
  .btn-stock-plus { background: var(--success-bg); color: var(--success-text); }
  .btn-stock-plus:hover { background: #bbf7d0; }

  /* --- Scan Hint --- */
  .scan-hint { 
    display: none; color: var(--success-text); font-size: 0.85rem; font-weight: 600; 
    margin-top: 0.75rem; align-items: center; gap: 0.5rem;
  }
  #scan-box:focus-within .scan-hint { display: flex; animation: hintPulse 2s infinite; }
  @keyframes hintPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

  /* --- Generic Buttons --- */
  .btn-action {
    border: none; border-radius: 12px; padding: 14px 24px; font-weight: 700; cursor: pointer;
    transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;
    text-decoration: none; font-size: 15px;
  }
  .btn-primary { background: var(--brand-primary); color: #fff; box-shadow: var(--shadow-sm); }
  .btn-primary:hover { background: var(--brand-primary-hover); transform: translateY(-1px); }
  
  .btn-secondary { background: var(--surface); color: var(--text-primary); border: 1px solid var(--border-subtle); }
  .btn-secondary:hover { background: var(--bg-app); }

  /* üìÖ Flatpickr Icons */
  .flatpickr-date {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px !important;
  }

  /* =========================================================
     2. New Inventory Toggle Styles
     ========================================================= */
  .inventory-toggle-wrapper {
    display: flex; align-items: center; gap: 1rem;
    background: var(--surface); padding: 1.25rem; border-radius: var(--radius-lg);
    border: 1px solid var(--border-subtle); margin-bottom: 1.5rem;
    transition: all 0.3s ease; box-shadow: var(--shadow-sm);
  }
  .inventory-toggle-wrapper.active-mode {
    border-color: var(--success-border); background: var(--success-bg);
  }
  
  /* Apple/Tailwind style switch */
  .switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: #cbd5e1; transition: .3s; border-radius: 34px;
  }
  .slider:before {
    position: absolute; content: ""; height: 18px; width: 18px;
    left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }
  input:checked + .slider { background-color: #10b981; }
  input:checked + .slider:before { transform: translateX(20px); }
  
  .toggle-text { display: flex; flex-direction: column; gap: 0.15rem; }
  .toggle-text strong { font-size: 0.95rem; font-weight: 600; color: var(--text-primary); }
  .toggle-text span { font-size: 0.8rem; color: var(--text-secondary); }
  .active-mode .toggle-text strong { color: var(--success-text); }
</style>

<div class="checkin-page">
  <div class="order-header">
    <div class="header-left">
      <h1>üì• Check-in</h1>
      <div class="page-subtitle">Inventory management and restocking hub.</div>
    </div>
    <form method="get" action="{% url 'new_product' %}">
      <input type="hidden" name="next" value="{{ request.path }}">
      <button type="submit" class="btn-action btn-primary">Ôºã New Product</button>
    </form>
  </div>

  <div class="main-grid">
    <div class="left-controls">
      
      <div class="inventory-toggle-wrapper" id="inventoryWrapper">
        <label class="switch">
            <input type="checkbox" id="inventorySwitch">
            <span class="slider"></span>
        </label>
        <div class="toggle-text">
            <strong>Inventory Count Mode</strong>
            <span>Auto-activate items on scan</span>
        </div>
      </div>

      <div class="control-box">
        <h3>üîç Search Products</h3>
        <div class="form-group autocomplete-wrapper">
          <label class="detail-label" for="name_query">Product Name / SKU</label>
          <input type="text" id="name_query" class="form-control" autocomplete="off" placeholder="Start typing...">
          <div id="autocomplete-results"></div>
        </div>
      </div>

      <div class="control-box" id="scan-box">
        <h3>üì± Barcode Scanner</h3>
        <form id="barcodeForm" method="post" action="{% url 'checkin' %}">
          {% csrf_token %}
          <input type="hidden" name="inventory_mode" id="hiddenInventoryMode" value="{{ request.GET.inventory_mode|default:'off' }}">
          <div class="form-group">
            <label class="detail-label" for="barcode">Scanning Field</label>
            <input type="text" id="barcode" name="barcode" class="form-control" autofocus placeholder="Ready for barcode...">
          </div>
        </form>
        <div class="scan-hint"><span>‚úÖ</span> Scanner is active</div>
      </div>
    </div>

    <div class="right-items">
      <div class="product-card">
        {% if product %}
          <div class="product-card-header">
            <div>
              <div class="product-name">{{ product.name }}</div>
              <div class="product-sub">Item Number: <strong>{{ product.item_number }}</strong></div>
            </div>
            <button type="button" class="btn-action btn-secondary" id="toggleEditBtn">‚úèÔ∏è Edit Details</button>
          </div>

          <div class="stock-wrapper">
            <div class="stock-control-group">
              <form method="post" action="{% url 'delete_one' product.product_id %}" onsubmit="this.inventory_mode.value = document.getElementById('inventorySwitch').checked ? 'true' : 'false'">
                  {% csrf_token %}
                  <input type="hidden" name="inventory_mode" value="{{ request.GET.inventory_mode|default:'off' }}">
                  <button type="submit" class="btn-stock-adj btn-stock-minus">Ôºç</button>
              </form>

              <div class="stock-display-chip">
                <span class="label">Units in Stock</span>
                <span class="value">{{ product.quantity_in_stock }}</span>
              </div>

              <form method="post" action="{% url 'add_quantity' product.product_id %}" onsubmit="this.inventory_mode.value = document.getElementById('inventorySwitch').checked ? 'true' : 'false'">
                  {% csrf_token %}
                  <input type="hidden" name="amount" value="1">
                  <input type="hidden" name="inventory_mode" value="{{ request.GET.inventory_mode|default:'off' }}">
                  <button type="submit" class="btn-stock-adj btn-stock-plus">Ôºã</button>
              </form>
            </div>
          </div>
          
          <form method="post" 
                action="{% url 'checkin_edit_product' product.product_id %}" 
                class="inline-edit-form" 
                id="inlineEditForm"
                onsubmit="this.inventory_mode.value = document.getElementById('inventorySwitch').checked ? 'true' : 'false'"> 
            {% csrf_token %}

            <input type="hidden" name="inventory_mode" value="{{ request.GET.inventory_mode|default:'off' }}">
            {{ edit_form.name.as_hidden }} {{ edit_form.brand.as_hidden }} {{ edit_form.quantity_in_stock.as_hidden }} {{ edit_form.price_per_unit.as_hidden }}
            
            <div class="checkin-details-grid" style="padding-bottom: 0;">
              <div class="detail-box status-box {% if product.status %}is-active{% else %}is-inactive{% endif %}">
                <div class="status-box-left">
                  <div class="detail-label" style="margin-bottom: 0;">Market Status</div>
                  <div class="detail-value view-mode">
                    <span class="status-pill {% if product.status %}active{% else %}inactive{% endif %}">
                      {% if product.status %}Active{% else %}Inactive{% endif %}
                    </span>
                  </div>
                  <div class="edit-mode" style="margin-top: 6px;">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                      {{ edit_form.status }}
                      <span style="font-size:0.9rem; font-weight:600; color:var(--text-primary);">Mark as Active</span>
                    </label>
                  </div>
                </div>
                <div class="status-box-right view-mode">
                  {% if product.status %}
                    <span style="font-size:0.75rem; color:var(--success-text); font-weight:600; background:#d1fae5; padding:4px 10px; border-radius:12px;">Visible &amp; Sellable</span>
                  {% else %}
                    <span style="font-size:0.75rem; color:var(--danger-text); font-weight:600; background:#fee2e2; padding:4px 10px; border-radius:12px;">Hidden from Orders</span>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="checkin-details-grid">
              <div class="detail-box">
                <div class="detail-label">Barcode / UPC</div>
                <div class="detail-value view-mode">{{ product.barcode|default:"‚Äî" }}</div>
                <div class="edit-mode">{{ edit_form.barcode }}</div>
              </div>
              <div class="detail-box">
                <div class="detail-label">Retail Price</div>
                <div class="detail-value view-mode">${{ product.price|floatformat:2 }}</div>
                <div class="edit-mode">{{ edit_form.price }}</div>
              </div>
              <div class="detail-box">
                <div class="detail-label">Expiry Date</div>
                <div class="detail-value view-mode">{% if product.expiry_date %}{{ product.expiry_date|date:"d-m-Y" }}{% else %}N/A{% endif %}</div>
                <div class="edit-mode">{{ edit_form.expiry_date }}</div>
              </div>
              <div class="detail-box">
                <div class="detail-label">Category</div>
                <div class="detail-value view-mode">{{ product.category.name|default:"‚Äî" }}</div>
                <div class="edit-mode">{{ edit_form.category }}</div>
              </div>
            </div>

            <div class="checkin-details-grid">
              <div class="detail-box">
                <div class="detail-label">Tax Status</div>
                <div class="detail-value view-mode">
                  <span class="status-pill {% if product.taxable %}active{% else %}inactive{% endif %}">
                    {{ product.taxable|yesno:"Taxable,Tax Exempt" }}
                  </span>
                </div>
                <div class="edit-mode">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding-top: 4px;">
                    {{ edit_form.taxable }} <span style="font-size: 0.9rem; font-weight: 600;">Apply Sales Tax</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="edit-actions" id="inlineEditActions" style="display:none; padding: 0 1.5rem 1.5rem; justify-content: flex-end; gap: 1rem;">
              <button type="button" class="btn-action btn-secondary" id="cancelInlineEdit">Cancel</button>
              <button type="submit" class="btn-action btn-primary">üíæ Save Updates</button>
            </div>
          </form>

        {% else %}
          <div style="text-align:center; padding: 6rem 2rem; color: var(--text-secondary);">
            <div style="font-size: 4rem; margin-bottom: 1.5rem; opacity: 0.5;">üì¶</div>
            <p style="font-weight: 700; font-size: 1.25rem; color: var(--text-primary); margin-bottom: 0.5rem;">No Item Selected</p>
            <p style="font-size: 0.95rem;">Scan a product or use the search bar on the left to begin.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{{ all_products|json_script:"products-json" }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const barcodeInput = document.getElementById('barcode');
    const searchInput = document.getElementById('name_query');
    const inlineForm = document.getElementById('inlineEditForm');
    const resultsContainer = document.getElementById('autocomplete-results');
    const editBtn = document.getElementById('toggleEditBtn');
    const editActions = document.getElementById('inlineEditActions');
    
    // --- 1. TOGGLE LOGIC ---
    const switchEl = document.getElementById('inventorySwitch');
    const wrapper = document.getElementById('inventoryWrapper');
    const hiddenInput = document.getElementById('hiddenInventoryMode');
    const subtitle = document.querySelector('.page-subtitle');

    const INV_STORAGE_KEY = 'mpcp_inventory_mode';

    // 1a. Check URL params first, then fall back to sessionStorage for persistence
    const urlParams = new URLSearchParams(window.location.search);
    const urlHasParam = urlParams.has('inventory_mode');
    const isInventoryMode = urlParams.get('inventory_mode') === 'true' ||
        (!urlHasParam && sessionStorage.getItem(INV_STORAGE_KEY) === 'true');

    if (isInventoryMode) {
        switchEl.checked = true;
        wrapper.classList.add('active-mode');
        hiddenInput.value = "true";
        subtitle.textContent = "‚ö†Ô∏è INVENTORY MODE: Scanning will Activate products.";
        sessionStorage.setItem(INV_STORAGE_KEY, 'true');
    }

    // 1b. Listen for toggle changes
    switchEl.addEventListener('change', function() {
        if (this.checked) {
            wrapper.classList.add('active-mode');
            hiddenInput.value = "true";
            subtitle.textContent = "‚ö†Ô∏è INVENTORY MODE: Scanning will Activate products.";
            sessionStorage.setItem(INV_STORAGE_KEY, 'true');
        } else {
            wrapper.classList.remove('active-mode');
            hiddenInput.value = "false";
            subtitle.textContent = "Inventory management and restocking hub.";
            sessionStorage.removeItem(INV_STORAGE_KEY);
        }
        // Return focus to barcode for speed
        if (barcodeInput) barcodeInput.focus();
    });

    // --- 2. CORE REFOCUS LOGIC ---
    let idleTimer;
    const forceScannerFocus = () => {
        if (barcodeInput && document.activeElement !== barcodeInput) {
            barcodeInput.focus();
        }
    };

    const resetIdleTimer = () => {
        clearTimeout(idleTimer);
        idleTimer = setTimeout(forceScannerFocus, 3000); 
    };

    if (barcodeInput) {
        barcodeInput.focus(); 
        ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(evt => 
            document.addEventListener(evt, resetIdleTimer)
        );
        document.addEventListener('click', (e) => {
            // Don't steal focus if interacting with the toggle
            if (!['INPUT', 'SELECT', 'TEXTAREA', 'BUTTON', 'A', 'LABEL'].includes(e.target.tagName)) {
                forceScannerFocus();
            }
        });
        searchInput?.addEventListener('blur', () => {
            setTimeout(forceScannerFocus, 200); 
        });
    }

    // --- 3. SEARCH & DROPDOWN LOGIC ---
    if (searchInput) {
        const productsJson = document.getElementById('products-json');
        if (productsJson) {
            const products = JSON.parse(productsJson.textContent.trim());

            searchInput.addEventListener('input', function () {
                const query = this.value.trim().toLowerCase();
                resultsContainer.innerHTML = '';
                
                if (query.length < 2) { 
                    resultsContainer.classList.remove('active'); 
                    return; 
                }

                const matches = products.filter(p => {
                    const nameMatch = p.name ? p.name.toLowerCase().includes(query) : false;
                    const barcodeMatch = p.barcode ? String(p.barcode).toLowerCase().includes(query) : false;
                    const itemNumMatch = p.item_number ? String(p.item_number).toLowerCase().includes(query) : false;
                    
                    return nameMatch || barcodeMatch || itemNumMatch;
                }).slice(0, 8);

                if (matches.length > 0) {
                    resultsContainer.classList.add('active');
                    matches.forEach(p => {
                        const btn = document.createElement('button');
                        btn.className = 'autocomplete-item'; 
                        btn.type = 'button';
                        
                        const isBarcodeMatch = p.barcode && String(p.barcode).toLowerCase().includes(query);
                        const badgeText = isBarcodeMatch ? 'BC Match' : 'Name Match';

                        btn.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <strong>${p.name}</strong>
                                <span style="font-size: 0.65rem; background: #e0e7ff; color: var(--brand-primary); padding: 2px 6px; border-radius: 4px; font-weight: 700; text-transform: uppercase;">
                                    ${badgeText}
                                </span>
                            </div>
                            <small style="display:block; color:var(--text-secondary); font-size:0.75rem;">
                                SKU: ${p.item_number} &nbsp;|&nbsp; BC: ${p.barcode || 'N/A'} &nbsp;|&nbsp; Stock: ${p.quantity_in_stock}
                            </small>`;
                        
                        btn.onclick = (e) => {
                            e.preventDefault();
                            const f = document.createElement('form');
                            f.method = 'POST';
                            f.action = `/checkin/add/${p.product_id}/`;
                            const token = document.querySelector('[name=csrfmiddlewaretoken]').value;
                            const invMode = document.getElementById('inventorySwitch').checked ? 'true' : 'false';
                            f.innerHTML = `
                                <input type="hidden" name="csrfmiddlewaretoken" value="${token}">
                                <input type="hidden" name="quantity" value="1">
                                <input type="hidden" name="inventory_mode" value="${invMode}">
                            `;
                            document.body.appendChild(f);
                            f.submit();
                        };
                        resultsContainer.appendChild(btn);
                    });
                } else { 
                    resultsContainer.classList.remove('active'); 
                }
            });
            
            document.addEventListener('click', (e) => { 
                if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
                    resultsContainer.classList.remove('active');
                }
            });
        }
    }

    // --- 4. INLINE EDIT & DATE LOGIC ---
    if (editBtn && inlineForm) {
        editBtn.addEventListener('click', () => { 
            inlineForm.classList.add('is-editing'); 
            editActions.style.display = 'flex'; 
            editBtn.style.display = 'none'; 
        });
        document.getElementById('cancelInlineEdit')?.addEventListener('click', () => window.location.reload());
    }

    const expiryInput = document.querySelector('.flatpickr-date');
    if (expiryInput) {
        flatpickr(expiryInput, { dateFormat: "d-m-Y", allowInput: true, monthSelectorType: "static" });
        expiryInput.addEventListener('input', function() {
            let val = this.value.replace(/\D/g, ''); let out = '';
            if (val.length > 0) { 
                out += val.substring(0, 2); 
                if (val.length > 2) out += '-' + val.substring(2, 4); 
                if (val.length > 4) out += '-' + val.substring(4, 8); 
            }
            this.value = out.substring(0, 10);
        });
    }

    // --- 5. TOASTS ---
    document.querySelectorAll('.toast-msg').forEach(t => {
        setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 4000);
        t.querySelector('.toast-close')?.addEventListener('click', () => t.remove());
    });
});
</script>
{% endblock %}