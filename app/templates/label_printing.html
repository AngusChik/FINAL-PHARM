{% extends "base.html" %}
{% block title %}Label Printing Queue{% endblock %}

{% block content %}
<style>
  /* =========================================================
     1. Design System (Modern EZ Theme)
     ========================================================= */
  :root {
    --lp-primary: #4f46e5;
    --lp-success: #059669;
    --lp-danger: #dc2626;
    --lp-warning: #d97706;
    --lp-text: #1e293b;
    --lp-muted: #64748b;
    --lp-border: #e2e8f0;
  }

  .lp-page { 
    padding: 24px; max-width: 1400px; margin: 0 auto; 
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    color: var(--lp-text); background-color: #f8fafc;
    /* Added bottom padding so the fixed bar doesn't overlap the table */
    padding-bottom: 100px; 
  }

  /* --- Header Section --- */
  .lp-header {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: #fff; padding: 32px 36px; border-radius: 20px; margin-bottom: 32px;
    display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;
    box-shadow: 0 10px 30px rgba(79, 70, 229, 0.25);
  }
  .lp-header h1 { margin: 0; font-size: 30px; font-weight: 800; letter-spacing: -0.5px; }

  /* --- Bottom Action Bar --- */
  .lp-bottom-bar {
    position: fixed;
    bottom: 0; left: 0; width: 100%;
    background: #fff;
    border-top: 1px solid var(--lp-border);
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
    padding: 16px 32px;
    display: flex; justify-content: flex-end; align-items: center; gap: 12px;
    z-index: 900;
  }

  /* --- Sidebar Layout Grid --- */
  .lp-main-layout {
    display: grid;
    grid-template-columns: 360px 1fr;
    gap: 32px;
    align-items: start; /* Critical for sticky behavior */
  }

  /* --- Sticky Sidebar --- */
  .lp-sidebar {
    position: sticky;
    top: 24px;
    z-index: 100;
  }

  @media (max-width: 1100px) {
    .lp-main-layout { grid-template-columns: 1fr; }
    .lp-sidebar { position: static; }
  }

  /* --- Buttons --- */
  .btn-ez {
    border: none; border-radius: 8px; padding: 10px 18px; font-weight: 700; cursor: pointer;
    transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; font-size: 13px;
  }
  
  /* New Button Styles for the light bottom bar */
  .btn-ez-outline { background: #fff; color: var(--lp-text); border: 1px solid var(--lp-border); border-radius: 999px; }
  .btn-ez-outline:hover { background: #f8fafc; border-color: #cbd5e1; }

  .btn-ez-danger-outline { background: #fff; color: var(--lp-danger); border: 1px solid rgba(220, 38, 38, 0.3); border-radius: 999px; }
  .btn-ez-danger-outline:hover { background: #fef2f2; }

  .btn-ez-primary { background: var(--lp-primary); color: #fff; border-radius: 999px; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
  .btn-ez-primary:hover { background: #4338ca; transform: translateY(-1px); }

  .btn-ez-add { background: var(--lp-success); color: #fff; border-radius: 8px; padding: 6px 14px; font-size: 11px; width: 100%; justify-content: center; }

  /* --- Cards --- */
  .lp-card {
    background: #fff; border-radius: 10px; border: 1px solid var(--lp-border);
    box-shadow: 0 1px 3px rgba(0,0,0,0.06); margin-bottom: 24px; overflow: hidden;
  }
  .lp-card-head { padding: 14px 20px; background: #fcfcfd; border-bottom: 1px solid var(--lp-border); display: flex; justify-content: space-between; align-items: center; }
  .lp-card-head h3 { margin: 0; font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--lp-muted); letter-spacing: 1px; }

  .lp-search-input {
    border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px 13px; font-size: 14px; width: 100%; transition: all 0.2s;
  }
  .lp-search-input:focus { outline: none; border-color: var(--lp-primary); background: #fff; }

  /* --- Sidebar Result Items --- */
  .lp-result-item {
    padding: 16px 20px; border-bottom: 1px solid var(--lp-border); display: flex; flex-direction: column; gap: 10px; transition: background 0.2s;
  }
  .lp-result-item:hover { background: #f8fafc; }
  .lp-result-info strong { display: block; color: var(--lp-text); font-size: 14px; }
  .lp-result-info span { font-size: 11px; color: var(--lp-muted); font-family: monospace; }

  /* --- Table Styling --- */
  .table-ez { width: 100%; border-collapse: collapse; }
  .table-ez th { background: #1e293b; color: #fff; text-transform: uppercase; font-size: 11px; font-weight: 800; letter-spacing: 1px; padding: 16px 24px; text-align: left; }
  .table-ez td { padding: 16px 24px; border-bottom: 1px solid var(--lp-border); vertical-align: middle; font-size: 14px; }
  
  .row-permanent { background-color: #f5f7ff; }
  .barcode-chip { background: #f1f5f9; color: #475569; padding: 4px 8px; border-radius: 6px; font-family: monospace; font-size: 12px; font-weight: 600; }
  .source-badge { font-size: 9px; font-weight: 800; text-transform: uppercase; padding: 3px 8px; border-radius: 6px; background: #e2e8f0; color: #64748b; }

  .empty-state { padding: 60px 20px; text-align: center; color: var(--lp-muted); }

  /* --- Modal Styling --- */
  .lp-modal-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(15, 23, 42, 0.6); z-index: 1000; align-items: center; justify-content: center;
    backdrop-filter: blur(4px);
  }
  .lp-modal-content {
    background: #fff; border-radius: 16px; width: 100%; max-width: 600px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); overflow: hidden;
    display: flex; flex-direction: column; max-height: 85vh;
  }
  .lp-modal-header {
    padding: 20px 24px; border-bottom: 1px solid var(--lp-border);
    display: flex; justify-content: space-between; align-items: center; background: #f8fafc;
  }
  .lp-modal-header h3 { margin: 0; font-size: 18px; font-weight: 800; color: var(--lp-text); }
  .lp-modal-close { cursor: pointer; font-size: 24px; color: var(--lp-muted); border: none; background: none; }
  .lp-modal-body { padding: 20px 24px; overflow-y: auto; flex-grow: 1; }
  .lp-modal-footer { padding: 16px 24px; border-top: 1px solid var(--lp-border); background: #f8fafc; text-align: right; }
  
  .lp-checkbox-item {
    display: flex; align-items: center; gap: 12px; padding: 12px; 
    border: 1px solid var(--lp-border); border-radius: 8px; margin-bottom: 8px;
    cursor: pointer; transition: background 0.2s;
  }
  .lp-checkbox-item:hover { background: #f1f5f9; }
  .lp-checkbox-item input[type="checkbox"] { transform: scale(1.2); cursor: pointer; }
</style>

<div class="lp-page">
  <header class="lp-header">
    <div class="lp-header-title">
      <h1>üè∑Ô∏è Label Queue</h1>
      <div style="font-size: 13px; opacity: 0.85; margin-top: 4px;">Prepare and preview items for barcode printing.</div>
    </div>
  </header>

  <div class="lp-main-layout">
    
    <aside class="lp-sidebar">
      <div class="lp-card">
        <div class="lp-card-head">
          <h3>‚ö° Quick Actions</h3>
        </div>
        <div style="padding: 20px; display: flex; flex-direction: column; gap: 16px;">

          <form method="post" style="margin: 0;">
            {% csrf_token %}
            <div style="display: flex; gap: 8px;">
              <input type="text" name="barcode" class="lp-search-input" placeholder="Scan barcode..." autofocus>
              <button type="submit" name="quick_scan" class="btn-ez" style="background: var(--lp-primary); color: #fff;">Scan</button>
            </div>
          </form>

          <hr style="border-top: 1px solid var(--lp-border); margin: 0;">

          <div style="display: flex; flex-direction: column; gap: 8px;">
            <select id="categorySelect" class="lp-search-input">
              <option value="">-- Select Category --</option>
              {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
              {% endfor %}
            </select>
            <button type="button" id="openCategoryModalBtn" class="btn-ez" style="background: #1e293b; color: #fff; justify-content: center;">
              Review & Add Category
            </button>
          </div>

          <hr style="border-top: 1px solid var(--lp-border); margin: 0;">

          <!--
          <form method="post" style="margin: 0;">
            {% csrf_token %}
            <button type="submit" name="add_low_stock" class="btn-ez" style="background: var(--lp-warning); color: #fff; width: 100%; justify-content: center;">
              Add Low Stock Items (‚â§3)
            </button>
          </form>
        -->
        </div>
      </div>

      <div class="lp-card">
        <div class="lp-card-head">
          <h3>üîç Add Products</h3>
        </div>
        <div style="padding: 20px;">
          <form method="get" class="d-flex flex-column gap-3">
            <input type="text" name="q" class="lp-search-input" placeholder="Name or Barcode..." value="{{ query }}">
            <button type="submit" class="btn-ez" style="background:#1e293b; color:#fff; width: 100%; justify-content: center;">Search Database</button>
          </form>
        </div>

        {% if search_results %}
        <div style="border-top: 1px solid var(--lp-border); max-height: 500px; overflow-y: auto;">
          {% for p in search_results %}
          <div class="lp-result-item">
            <div class="lp-result-info">
              <strong>{{ p.name }}</strong>
              <span>UPC: {{ p.barcode }}</span>
            </div>
            <form method="post" style="margin:0;">
              {% csrf_token %}
              <input type="hidden" name="product_id" value="{{ p.product_id }}">
              <button type="submit" name="add_product" class="btn-ez btn-ez-add">Ôºã Add to Queue</button>
            </form>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </aside>

    <main class="lp-content">
      <div class="lp-card">
        <div class="lp-card-head">
          <h3>Sheet Preview</h3>
          <span style="font-size: 11px; font-weight: 800; color: var(--lp-primary); background: #f0f2ff; padding: 4px 12px; border-radius: 20px;">
            {{ category_items.count|add:session_queue|length }} Labels Ready
          </span>
        </div>
        
        <div style="overflow-x: auto;">
          <table class="table-ez">
            <thead>
              <tr>
                <th style="width: 50px;">#</th>
                <th>Product Description</th>
                <th>Barcode</th>
                <th>Price</th>
                <th style="text-align: right;">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for item in category_items %}
              <tr class="row-permanent">
                <td style="color: var(--lp-muted); font-weight: 600;">{{ forloop.counter }}</td>
                <td>
                  <div style="font-weight: 700;">{{ item.name }}</div>
                  {% if item.previous_category %}
                  <div style="font-size: 11px; color: var(--lp-muted);">Will revert to: {{ item.previous_category.name }}</div>
                  {% endif %}
                </td>
                <td><span class="barcode-chip">{{ item.barcode }}</span></td>
                <td style="font-weight: 800; color: var(--lp-primary);">${{ item.price }}</td>
                <td style="text-align: right;"><span class="source-badge">Inventory List</span></td>
              </tr>
              {% endfor %}

              {% for item in session_queue %}
              <tr>
                {% with start_index=category_items.count %}
                <td style="color: var(--lp-muted); font-weight: 600;">{{ forloop.counter|add:start_index }}</td>
                {% endwith %}
                <td style="font-weight: 700;">{{ item.name }}</td>
                <td><span class="barcode-chip">{{ item.barcode }}</span></td>
                <td style="font-weight: 800; color: var(--lp-primary);">${{ item.price }}</td>
                <td style="text-align: right;">
                  <form method="post" style="margin:0;">
                    {% csrf_token %}
                    <input type="hidden" name="remove_index" value="{{ forloop.counter0 }}">
                    <button type="submit" style="background:none; border:none; color:var(--lp-danger); font-size: 11px; font-weight: 800; cursor: pointer;">REMOVE</button>
                  </form>
                </td>
              </tr>
              {% endfor %}

              {% if not category_items and not session_queue %}
              <tr>
                <td colspan="5">
                  <div class="empty-state">
                    <div style="font-size: 40px; margin-bottom: 10px;">üìÑ</div>
                    <p style="font-weight: 700; color: var(--lp-text);">Queue is Empty</p>
                    <p style="font-size: 12px;">Search and add products from the sidebar to begin.</p>
                  </div>
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </main>

  </div>
</div>

<div class="lp-bottom-bar">
  <div style="flex-grow: 1; display: flex; align-items: center; gap: 12px; color: var(--lp-muted); font-size: 13px; font-weight: 600;">
    {% if can_undo %}
    <form method="post" style="margin:0;">
      {% csrf_token %}
      <button type="submit" name="undo_action" class="btn-ez btn-ez-outline">
        ‚Ü©Ô∏è Undo Last Action
      </button>
    </form>
    {% endif %}
  </div>

  <form method="post" action="{% url 'revert_labels' %}" style="margin:0;">
    {% csrf_token %}
    <button type="submit" class="btn-ez btn-ez-outline">üîÑ Revert Categories</button>
  </form>
  
  <form method="post" style="margin:0;">
    {% csrf_token %}
    <button type="submit" name="clear_queue" class="btn-ez btn-ez-danger-outline">üóëÔ∏è Clear Queue</button>
  </form>
  
  <a href="{% url 'generate_label_pdf' %}" target="_blank" class="btn-ez btn-ez-primary">üñ®Ô∏è Generate PDF</a>
</div>
<div id="categoryModal" class="lp-modal-overlay">
  <div class="lp-modal-content">
    <div class="lp-modal-header">
      <h3>Select Products to Print</h3>
      <button class="lp-modal-close" id="closeModalBtn">&times;</button>
    </div>
    
    <form method="post" style="margin: 0; display: flex; flex-direction: column; overflow: hidden;">
      {% csrf_token %}
      <div class="lp-modal-body">
        
        <label class="lp-checkbox-item" style="background: var(--lp-border); font-weight: 800;">
          <input type="checkbox" id="selectAllCheckbox" checked>
          Select / Deselect All
        </label>
        <hr style="border: 0; border-top: 1px solid var(--lp-border); margin: 16px 0;">
        
        <div id="modalProductList"></div>
        
      </div>
      <div class="lp-modal-footer">
        <button type="button" class="btn-ez btn-ez-outline" id="cancelModalBtn" style="border-color: var(--lp-border);">Cancel</button>
        <button type="submit" name="add_selected_products" class="btn-ez btn-ez-primary">Add Selected to Queue</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const openBtn = document.getElementById('openCategoryModalBtn');
    const closeBtns = [document.getElementById('closeModalBtn'), document.getElementById('cancelModalBtn')];
    const modal = document.getElementById('categoryModal');
    const listContainer = document.getElementById('modalProductList');
    const selectAllCb = document.getElementById('selectAllCheckbox');

    // 1. Open Modal & Fetch Data
    openBtn.addEventListener('click', function() {
      const catId = document.getElementById('categorySelect').value;
      if (!catId) {
        alert('Please select a category from the dropdown first.');
        return;
      }

      // Change button text to show loading state
      const originalText = openBtn.innerText;
      openBtn.innerText = "Loading...";

      // Fetch products as JSON
      fetch(`?category_id=${catId}`, {
        headers: { 'Accept': 'application/json' }
      })
      .then(response => response.json())
      .then(data => {
        listContainer.innerHTML = ''; // Clear previous
        
        if (data.products.length === 0) {
            listContainer.innerHTML = '<p style="text-align:center; color:#64748b;">No active products found in this category.</p>';
        } else {
            // Build the checkbox list
            data.products.forEach(p => {
              listContainer.innerHTML += `
                <label class="lp-checkbox-item">
                  <input type="checkbox" name="selected_products" value="${p.product_id}" checked>
                  <div style="display:flex; flex-direction:column;">
                    <span style="font-weight: 700; color: #1e293b;">${p.name}</span>
                    <span style="font-size: 11px; color: #64748b; font-family: monospace;">UPC: ${p.barcode} | $${p.price}</span>
                  </div>
                </label>
              `;
            });
        }
        
        selectAllCb.checked = true; // Reset select all toggle
        modal.style.display = 'flex'; // Show modal
      })
      .catch(error => alert("Error fetching products."))
      .finally(() => {
          openBtn.innerText = originalText; // Reset button
      });
    });

    // 2. Close Modal Logic
    closeBtns.forEach(btn => {
      btn.addEventListener('click', () => modal.style.display = 'none');
    });

    // Close when clicking outside the modal content
    modal.addEventListener('click', function(e) {
      if (e.target === modal) modal.style.display = 'none';
    });

    // 3. Select All Logic
    selectAllCb.addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('input[name="selected_products"]');
      checkboxes.forEach(cb => cb.checked = this.checked);
    });
  });
</script>
{% endblock %}