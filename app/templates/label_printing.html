{% extends "base.html" %}
{% block title %}Label Printing Queue{% endblock %}

{% block content %}
<style>
  /* =========================================================
     1. Design System (Modern EZ Theme)
     ========================================================= */
  :root {
    --lp-primary: #4f46e5;
    --lp-secondary: #7c3aed;
    --lp-success: #10b981;
    --lp-danger: #ef4444;
    --lp-warning: #f59e0b;
    --lp-bg: #f8fafc;
    --lp-border: #e2e8f0;
    --lp-text-main: #1e293b;
    --lp-text-muted: #64748b;
  }

  .lp-page { 
    padding: 24px; max-width: 1400px; margin: 0 auto; 
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    color: var(--lp-text-main); background-color: var(--lp-bg);
  }

  /* --- Header Section --- */
  .lp-header {
    background: linear-gradient(135deg, var(--lp-primary) 0%, var(--lp-secondary) 100%);
    color: #fff; padding: 32px; border-radius: 24px; margin-bottom: 32px;
    box-shadow: 0 10px 25px rgba(79, 70, 229, 0.2);
    display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;
  }
  .lp-header h1 { margin: 0; font-size: 30px; font-weight: 800; letter-spacing: -1px; }
  .lp-header-actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

  /* --- Sidebar Layout Grid --- */
  .lp-main-layout {
    display: grid;
    grid-template-columns: 360px 1fr;
    gap: 32px;
    align-items: start; /* Critical for sticky behavior */
  }

  /* --- Sticky Sidebar --- */
  .lp-sidebar {
    position: sticky;
    top: 24px;
    z-index: 100;
  }

  @media (max-width: 1100px) {
    .lp-main-layout { grid-template-columns: 1fr; }
    .lp-sidebar { position: static; }
  }

  /* --- Buttons --- */
  .btn-ez {
    border: none; border-radius: 12px; padding: 10px 18px; font-weight: 700; cursor: pointer;
    transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; font-size: 13px;
  }
  .btn-ez-soft { background: rgba(255, 255, 255, 0.15); color: #fff; border: 1px solid rgba(255, 255, 255, 0.2); }
  .btn-ez-soft:hover { background: rgba(255, 255, 255, 0.25); transform: translateY(-1px); }
  
  .btn-ez-print { background: #fff; color: var(--lp-primary); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  .btn-ez-print:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }

  .btn-ez-add { background: var(--lp-success); color: #fff; border-radius: 20px; padding: 6px 14px; font-size: 11px; width: 100%; justify-content: center; }

  /* --- Cards --- */
  .lp-card {
    background: #fff; border-radius: 20px; border: 1px solid var(--lp-border);
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 24px; overflow: hidden;
  }
  .lp-card-head { padding: 18px 24px; background: #fcfcfd; border-bottom: 1px solid var(--lp-border); display: flex; justify-content: space-between; align-items: center; }
  .lp-card-head h3 { margin: 0; font-size: 12px; font-weight: 800; text-transform: uppercase; color: var(--lp-text-muted); letter-spacing: 1px; }

  .lp-search-input {
    border: 2px solid var(--lp-border); border-radius: 12px; padding: 12px 16px; font-size: 14px; width: 100%; transition: all 0.2s;
  }
  .lp-search-input:focus { outline: none; border-color: var(--lp-primary); background: #fff; }

  /* --- Sidebar Result Items --- */
  .lp-result-item {
    padding: 16px 20px; border-bottom: 1px solid var(--lp-border); display: flex; flex-direction: column; gap: 10px; transition: background 0.2s;
  }
  .lp-result-item:hover { background: #f8fafc; }
  .lp-result-info strong { display: block; color: var(--lp-text-main); font-size: 14px; }
  .lp-result-info span { font-size: 11px; color: var(--lp-text-muted); font-family: monospace; }

  /* --- Table Styling --- */
  .table-ez { width: 100%; border-collapse: collapse; }
  .table-ez th { background: #1e293b; color: #fff; text-transform: uppercase; font-size: 10px; font-weight: 800; letter-spacing: 1px; padding: 16px 24px; text-align: left; }
  .table-ez td { padding: 16px 24px; border-bottom: 1px solid var(--lp-border); vertical-align: middle; font-size: 14px; }
  
  .row-permanent { background-color: #f5f7ff; }
  .barcode-chip { background: #f1f5f9; color: #475569; padding: 4px 8px; border-radius: 6px; font-family: monospace; font-size: 12px; font-weight: 600; }
  .source-badge { font-size: 9px; font-weight: 800; text-transform: uppercase; padding: 3px 8px; border-radius: 6px; background: #e2e8f0; color: #64748b; }

  .empty-state { padding: 60px 20px; text-align: center; color: var(--lp-text-muted); }
</style>

<div class="lp-page">
  <header class="lp-header">
    <div class="lp-header-title">
      <h1>üè∑Ô∏è Label Queue</h1>
      <div style="font-size: 13px; opacity: 0.85; margin-top: 4px;">Prepare and preview items for barcode printing.</div>
    </div>
    <div class="lp-header-actions">
      <form method="post" action="{% url 'revert_labels' %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn-ez btn-ez-soft">üîÑ Revert Categories</button>
      </form>
      <form method="post" style="display:inline;">
        {% csrf_token %}
        <button type="submit" name="clear_queue" class="btn-ez btn-ez-soft" style="background:rgba(239, 68, 68, 0.2);">Clear Queue</button>
      </form>
      <a href="{% url 'generate_label_pdf' %}" target="_blank" class="btn-ez btn-ez-print">üñ®Ô∏è Generate PDF</a>
    </div>
  </header>

  <div class="lp-main-layout">
    
    <aside class="lp-sidebar">
      <div class="lp-card">
        <div class="lp-card-head">
          <h3>üîç Add Products</h3>
        </div>
        <div style="padding: 20px;">
          <form method="get" class="d-flex flex-column gap-3">
            <input type="text" name="q" class="lp-search-input" placeholder="Name or Barcode..." value="{{ query }}">
            <button type="submit" class="btn-ez" style="background:#1e293b; color:#fff; width: 100%; justify-content: center;">Search Database</button>
          </form>
        </div>

        {% if search_results %}
        <div style="border-top: 1px solid var(--lp-border); max-height: 500px; overflow-y: auto;">
          {% for p in search_results %}
          <div class="lp-result-item">
            <div class="lp-result-info">
              <strong>{{ p.name }}</strong>
              <span>UPC: {{ p.barcode }}</span>
            </div>
            <form method="post" style="margin:0;">
              {% csrf_token %}
              <input type="hidden" name="product_id" value="{{ p.product_id }}">
              <button type="submit" name="add_product" class="btn-ez btn-ez-add">Ôºã Add to Queue</button>
            </form>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </aside>

    <main class="lp-content">
      <div class="lp-card">
        <div class="lp-card-head">
          <h3>Sheet Preview</h3>
          <span style="font-size: 11px; font-weight: 800; color: var(--lp-primary); background: #f0f2ff; padding: 4px 12px; border-radius: 20px;">
            {{ category_items.count|add:session_queue|length }} Labels Ready
          </span>
        </div>
        
        <div style="overflow-x: auto;">
          <table class="table-ez">
            <thead>
              <tr>
                <th style="width: 50px;">#</th>
                <th>Product Description</th>
                <th>Barcode</th>
                <th>Price</th>
                <th style="text-align: right;">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for item in category_items %}
              <tr class="row-permanent">
                <td style="color: var(--lp-text-muted); font-weight: 600;">{{ forloop.counter }}</td>
                <td>
                  <div style="font-weight: 700;">{{ item.name }}</div>
                  {% if item.previous_category %}
                  <div style="font-size: 11px; color: var(--lp-text-muted);">Will revert to: {{ item.previous_category.name }}</div>
                  {% endif %}
                </td>
                <td><span class="barcode-chip">{{ item.barcode }}</span></td>
                <td style="font-weight: 800; color: var(--lp-primary);">${{ item.price }}</td>
                <td style="text-align: right;"><span class="source-badge">Inventory List</span></td>
              </tr>
              {% endfor %}

              {% for item in session_queue %}
              <tr>
                {% with start_index=category_items.count %}
                <td style="color: var(--lp-text-muted); font-weight: 600;">{{ forloop.counter|add:start_index }}</td>
                {% endwith %}
                <td style="font-weight: 700;">{{ item.name }}</td>
                <td><span class="barcode-chip">{{ item.barcode }}</span></td>
                <td style="font-weight: 800; color: var(--lp-primary);">${{ item.price }}</td>
                <td style="text-align: right;">
                  <form method="post" style="margin:0;">
                    {% csrf_token %}
                    <input type="hidden" name="remove_index" value="{{ forloop.counter0 }}">
                    <button type="submit" style="background:none; border:none; color:var(--lp-danger); font-size: 11px; font-weight: 800; cursor: pointer;">REMOVE</button>
                  </form>
                </td>
              </tr>
              {% endfor %}

              {% if not category_items and not session_queue %}
              <tr>
                <td colspan="5">
                  <div class="empty-state">
                    <div style="font-size: 40px; margin-bottom: 10px;">üìÑ</div>
                    <p style="font-weight: 700; color: var(--lp-text-main);">Queue is Empty</p>
                    <p style="font-size: 12px;">Search and add products from the sidebar to begin.</p>
                  </div>
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </main>

  </div>
</div>
{% endblock %}